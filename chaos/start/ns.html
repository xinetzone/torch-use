
<!DOCTYPE html>

<html lang="zh_CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Pytorch æ•°å€¼å¥—ä»¶æ•™ç¨‹ &#8212; torch-book 0.0.1 æ–‡æ¡£</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" href="../../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/tabs.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/default.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/tabs.js"></script>
    <script async="async" kind="hypothesis" src="https://hypothes.is/embed.js"></script>
    <script kind="utterances">

    var commentsRunWhenDOMLoaded = cb => {
    if (document.readyState != 'loading') {
        cb()
    } else if (document.addEventListener) {
        document.addEventListener('DOMContentLoaded', cb)
    } else {
        document.attachEvent('onreadystatechange', function() {
        if (document.readyState == 'complete') cb()
        })
    }
}

var addUtterances = () => {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src = "https://utteranc.es/client.js";
    script.async = "async";

    script.setAttribute("repo", "xinetzone/torch-book");
    script.setAttribute("issue-term", "pathname");
    script.setAttribute("theme", "github-light");
    script.setAttribute("label", "ğŸ’¬ comment");
    script.setAttribute("crossorigin", "anonymous");

    sections = document.querySelectorAll("div.section");
    if (sections !== null) {
        section = sections[sections.length-1];
        section.appendChild(script);
    }
}
commentsRunWhenDOMLoaded(addUtterances);
</script>
    <script src="../../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script src="../../_static/translations.js"></script>
    <script src="../../_static/design-tabs.js"></script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({startOnLoad:true});</script>
    <link rel="canonical" href="https://xinetzone.github.io/torch-book/chaos/start/ns.html" />
    <link rel="shortcut icon" href="../../_static/favicon.jpg"/>
    <link rel="index" title="ç´¢å¼•" href="../../genindex.html" />
    <link rel="search" title="æœç´¢" href="../../search.html" />
    <link rel="next" title="å­¦ä¹ " href="../study/index.html" />
    <link rel="prev" title="åŸºç¡€" href="basic.html" /> 
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="zh_CN">
    

    <!-- Google Analytics -->
     
<link
  rel="alternate"
  type="application/atom+xml"
  href="../../posts/atom.xml"
  title="Blog"
/>
 
<style type="text/css">
  ul.ablog-archive {
    list-style: none;
    overflow: auto;
    margin-left: 0px;
  }
  ul.ablog-archive li {
    float: left;
    margin-right: 5px;
    font-size: 80%;
  }
  ul.postlist a {
    font-style: italic;
  }
  ul.postlist-style-disc {
    list-style-type: disc;
  }
  ul.postlist-style-none {
    list-style-type: none;
  }
  ul.postlist-style-circle {
    list-style-type: circle;
  }
</style>

  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../../_static/logo.jpg" class="logo" alt="logo">
      
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../intro.html">
   é¡¹ç›®ç®€ä»‹
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../tutorials/index.html">
   æ•™ç¨‹
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../tutorials/basics/index.html">
     PyTorch åŸºç¡€
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
    <label for="toctree-checkbox-2">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../../tutorials/basics/quickstart.html">
       å¿«é€Ÿå…¥é—¨
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../tutorials/basics/autogradqs.html">
       è‡ªåŠ¨å¾®åˆ†
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../tutorials/object-detection/index.html">
     ç›®æ ‡æ£€æµ‹
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
    <label for="toctree-checkbox-3">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3 has-children">
      <a class="reference internal" href="../../tutorials/object-detection/yolo/index.html">
       YOLO ç³»åˆ—
      </a>
      <input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
      <label for="toctree-checkbox-4">
       <i class="fas fa-chevron-down">
       </i>
      </label>
      <ul>
       <li class="toctree-l4">
        <a class="reference internal" href="../../tutorials/object-detection/yolo/intro.html">
         YOLO ç®€ä»‹
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../tutorials/object-detection/yolo/tutorials/index.html">
         YOLO æ•™ç¨‹
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../tutorials/notes/index.html">
     ç¬”è®°
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/>
    <label for="toctree-checkbox-5">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../../tutorials/notes/autograd-mechanics.html">
       è‡ªåŠ¨å¾®åˆ†æœºåˆ¶
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../tutorials/notes/detection.html">
       ç›®æ ‡æ£€æµ‹
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../tutorials/notes/extending.html">
       æ‰©å±• PyTorch
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../tutorials/notes/thop.html">
       THOP: PyTorch OpCounter
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../tutorials/seg-fine-tuning.html">
     å¾®è°ƒåˆ†å‰²
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../quant/index.html">
   é‡åŒ–
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/>
  <label for="toctree-checkbox-6">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../quant/intro.html">
     é‡åŒ–ç®€ä»‹
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../quant/start.html">
     å¿«é€Ÿå…¥é—¨
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../openmmlab/index.html">
   MMDetection
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/>
  <label for="toctree-checkbox-7">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../openmmlab/start.html">
     MMDect å¿«é€Ÿä¸Šæ‰‹
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="../index.html">
   Eager é‡åŒ–(æ··ä¹±)
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" type="checkbox"/>
  <label for="toctree-checkbox-8">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2">
    <a class="reference internal" href="../intro.html">
     é‡åŒ–ç®€ä»‹ï¼ˆEagerï¼‰
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../recipes.html">
     é‡åŒ–èœè°±
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../quantized-tensor.html">
     é‡åŒ–å¼ é‡
    </a>
   </li>
   <li class="toctree-l2 current active has-children">
    <a class="reference internal" href="index.html">
     å¿«é€Ÿä¸Šæ‰‹
    </a>
    <input checked="" class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" type="checkbox"/>
    <label for="toctree-checkbox-9">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul class="current">
     <li class="toctree-l3">
      <a class="reference internal" href="basic.html">
       åŸºç¡€
      </a>
     </li>
     <li class="toctree-l3 current active">
      <a class="current reference internal" href="#">
       Pytorch æ•°å€¼å¥—ä»¶æ•™ç¨‹
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../study/index.html">
     å­¦ä¹ 
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" type="checkbox"/>
    <label for="toctree-checkbox-10">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../study/intro.html">
       æ¦‚è¿°
      </a>
     </li>
     <li class="toctree-l3 has-children">
      <a class="reference internal" href="../study/transfer-learning/index.html">
       è¿ç§»å­¦ä¹ 
      </a>
      <input class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" type="checkbox"/>
      <label for="toctree-checkbox-11">
       <i class="fas fa-chevron-down">
       </i>
      </label>
      <ul>
       <li class="toctree-l4">
        <a class="reference internal" href="../study/transfer-learning/basic.html">
         è®¡ç®—æœºè§†è§‰åˆ†ç±»
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../study/transfer-learning/quantized.html">
         é‡åŒ–è®¡ç®—æœºè§†è§‰åˆ†ç±»
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../study/transfer-learning/custom.html">
         è‡ªå®šä¹‰
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../study/transfer-learning/cifar.html">
         æµ‹è¯•
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../study/transfer-learning/tvm.html">
         TVM
        </a>
       </li>
      </ul>
     </li>
     <li class="toctree-l3 has-children">
      <a class="reference internal" href="../study/advanced/index.html">
       é«˜çº§æ•™ç¨‹
      </a>
      <input class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" type="checkbox"/>
      <label for="toctree-checkbox-12">
       <i class="fas fa-chevron-down">
       </i>
      </label>
      <ul>
       <li class="toctree-l4">
        <a class="reference internal" href="../study/advanced/custom.html">
         è‡ªå®šä¹‰é‡åŒ–
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../study/advanced/run.html">
         é€šç”¨é‡åŒ–æ¨¡å‹
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../study/advanced/qat.html">
         QAT
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../study/advanced/cifar.html">
         ç‰¹å®šäº cifar10 çš„é‡åŒ–ï¼ˆå¾…æ›´ï¼‰
        </a>
       </li>
      </ul>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../study/qat-resnet18.html">
       QATï¼ˆresnet18ï¼‰
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../study/test.html">
       æµ‹è¯• QAT
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../study/draft.html">
       å›æ”¶ç«™
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../tutorial/index.html">
     æ•™ç¨‹
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-13" name="toctree-checkbox-13" type="checkbox"/>
    <label for="toctree-checkbox-13">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../tutorial/pqt-qat.html">
       PTQ ä¸ QAT å®è·µ
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../tutorial/qat.html">
       QAT çš„ä¸åŒè®­ç»ƒç­–ç•¥
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../tutorial/qat-fuse.html">
       QAT çš„ä¸åŒè®­ç»ƒç­–ç•¥
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../tutorial/tvm.html">
       TVM åˆæ¢
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../papers/index.html">
     è®ºæ–‡
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-14" name="toctree-checkbox-14" type="checkbox"/>
    <label for="toctree-checkbox-14">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../papers/gholami2021survey.html">
       A Survey of Quantization Methods for Efficient Neural Network Inference
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../ecosystem/index.html">
   ç”Ÿæ€ç³»ç»Ÿ
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-15" name="toctree-checkbox-15" type="checkbox"/>
  <label for="toctree-checkbox-15">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../ecosystem/intro.html">
     ç®€ä»‹
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../others/index.html">
   å…¶ä»–
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-16" name="toctree-checkbox-16" type="checkbox"/>
  <label for="toctree-checkbox-16">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../others/colab.html">
     Colab è®­ç»ƒ
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../others/en-zh.html">
     ä¸­è‹±äº’è¯‘
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../others/raw.html">
     æœªæ•´ç†çš„èµ„æ–™
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../refs.html">
   å‚è€ƒ
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../glossary/index.html">
   æœ¯è¯­è¡¨
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-17" name="toctree-checkbox-17" type="checkbox"/>
  <label for="toctree-checkbox-17">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../glossary/numpy.html">
     NumPy
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../glossary/pytorch.html">
     PyTorch è¯æ±‡è¡¨
    </a>
   </li>
  </ul>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            <div>
ç‰ˆæƒæ‰€æœ‰Â Â©Â 2021 <a href="https://xinetzone.github.io/">xinetzone</a></div>
<div>ç”± <a href="https://ebp.jupyterbook.org/">EBP</a> æä¾›æŠ€æœ¯æ”¯æŒ</div>
<a href="https://torch-book.readthedocs.io/">ç‰ˆæœ¬åˆ‡æ¢</a>

            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<div class="menu-dropdown menu-dropdown-launch-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Launch interactive content">
      <i class="fas fa-rocket"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://mybinder.org/v2/gh/xinetzone/torch-book/main?urlpath=lab/tree/docs/chaos/start/ns.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Binder"
>
  

<span class="headerbtn__icon-container">
  
    <img src="../../_static/images/logo_binder.svg">
  </span>
<span class="headerbtn__text-container">Binder</span>
</a>

      </li>
      
      <li>
        <a href="https://colab.research.google.com/github/xinetzone/torch-book/blob/main/docs/chaos/start/ns.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Colab"
>
  

<span class="headerbtn__icon-container">
  
    <img src="../../_static/images/logo_colab.png">
  </span>
<span class="headerbtn__text-container">Colab</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://github.com/xinetzone/torch-book"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/xinetzone/torch-book/issues/new?title=Issue%20on%20page%20%2Fchaos/start/ns.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/xinetzone/torch-book/edit/main/docs/chaos/start/ns.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Edit this page"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="headerbtn__text-container">suggest edit</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../../_sources/chaos/start/ns.ipynb.txt"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> å¯¼èˆª
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id1">
   æ•°å€¼å¥—ä»¶ä¹‹é™æ€é‡åŒ–
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id2">
     1. æ¯”è¾ƒæµ®ç‚¹æ¨¡å‹å’Œé‡åŒ–æ¨¡å‹çš„æƒé‡
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id3">
     2. æ¯”è¾ƒæµ®ç‚¹å’Œé‡åŒ–æ¨¡å‹åœ¨ç›¸åº”çš„ä½ç½®
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id4">
     3. ä½¿ç”¨ç›¸åŒçš„è¾“å…¥æ•°æ®ï¼Œå°†é‡åŒ–æ¨¡å‹ä¸­çš„æ¨¡å—ä¸ç­‰æ•ˆçš„æµ®ç‚¹æ¨¡å—è¿›è¡Œæ¯”è¾ƒ
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#numeric-suite">
   Numeric Suite ä¹‹åŠ¨æ€é‡åŒ–
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id6">
     è®¾ç½®
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#compare-the-weights-of-float-and-quantized-models">
     1. Compare the weights of float and quantized models
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#compare-float-point-and-quantized-models-at-corresponding-locations">
     2. Compare float point and quantized models at corresponding locations
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#compare-a-module-in-a-quantized-model-with-its-float-point-equivalent-with-the-same-input-data">
     3. Compare a module in a quantized model with its float point equivalent, with the same input data
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id7">
   ç»“è®º
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Pytorch æ•°å€¼å¥—ä»¶æ•™ç¨‹</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> å¯¼èˆª </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id1">
   æ•°å€¼å¥—ä»¶ä¹‹é™æ€é‡åŒ–
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id2">
     1. æ¯”è¾ƒæµ®ç‚¹æ¨¡å‹å’Œé‡åŒ–æ¨¡å‹çš„æƒé‡
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id3">
     2. æ¯”è¾ƒæµ®ç‚¹å’Œé‡åŒ–æ¨¡å‹åœ¨ç›¸åº”çš„ä½ç½®
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id4">
     3. ä½¿ç”¨ç›¸åŒçš„è¾“å…¥æ•°æ®ï¼Œå°†é‡åŒ–æ¨¡å‹ä¸­çš„æ¨¡å—ä¸ç­‰æ•ˆçš„æµ®ç‚¹æ¨¡å—è¿›è¡Œæ¯”è¾ƒ
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#numeric-suite">
   Numeric Suite ä¹‹åŠ¨æ€é‡åŒ–
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id6">
     è®¾ç½®
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#compare-the-weights-of-float-and-quantized-models">
     1. Compare the weights of float and quantized models
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#compare-float-point-and-quantized-models-at-corresponding-locations">
     2. Compare float point and quantized models at corresponding locations
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#compare-a-module-in-a-quantized-model-with-its-float-point-equivalent-with-the-same-input-data">
     3. Compare a module in a quantized model with its float point equivalent, with the same input data
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id7">
   ç»“è®º
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                 <div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">matplotlib</span> inline
</pre></div>
</div>
</div>
</div>
<section class="tex2jax_ignore mathjax_ignore" id="pytorch">
<h1>Pytorch æ•°å€¼å¥—ä»¶æ•™ç¨‹<a class="headerlink" href="#pytorch" title="æ°¸ä¹…é“¾æ¥è‡³æ ‡é¢˜">#</a></h1>
<p>å½“å®ƒå·¥ä½œæ—¶ï¼Œé‡åŒ–æ˜¯å¥½çš„ï¼Œä½†å¾ˆéš¾çŸ¥é“ä»€ä¹ˆæ˜¯é”™è¯¯çš„ï¼Œå½“å®ƒä¸æ»¡è¶³æˆ‘ä»¬æœŸæœ›çš„å‡†ç¡®æ€§ã€‚é‡åŒ–ç²¾åº¦é—®é¢˜çš„è°ƒè¯•å¹¶ä¸å®¹æ˜“ï¼Œä¸”è€—æ—¶è¾ƒé•¿ã€‚</p>
<p>è°ƒè¯•çš„ä¸€ä¸ªé‡è¦æ­¥éª¤æ˜¯åº¦é‡æµ®ç‚¹æ¨¡å‹åŠå…¶ç›¸åº”é‡åŒ–æ¨¡å‹çš„ç»Ÿè®¡é‡ï¼Œä»¥äº†è§£å®ƒä»¬çš„æœ€å¤§å·®å¼‚åœ¨å“ªé‡Œã€‚PyTorch é‡åŒ–ä¸­æ„å»ºäº†ä¸€å¥—åä¸º PyTorch Numeric Suite çš„æ•°å€¼å·¥å…·ï¼Œä»¥æ”¯æŒé‡åŒ–æ¨¡å—å’Œæµ®ç‚¹æ¨¡å—ä¹‹é—´çš„ç»Ÿè®¡é‡çš„åº¦é‡ï¼Œä»è€Œæ”¯æŒé‡åŒ–è°ƒè¯•å·¥ä½œã€‚å³ä½¿å¯¹äºç²¾åº¦è¾ƒé«˜çš„é‡åŒ–æ¨¡å‹ï¼ŒPyTorch Numeric Suite ä»ç„¶å¯ä»¥ä½œä¸ºå‰–æå·¥å…·ï¼Œæ›´å¥½åœ°ç†è§£æ¨¡å‹å†…éƒ¨çš„é‡åŒ–è¯¯å·®ï¼Œå¹¶ä¸ºè¿›ä¸€æ­¥ä¼˜åŒ–æä¾›æŒ‡å¯¼ã€‚</p>
<p>PyTorch Numeric Suite ç›®å‰æ”¯æŒé€šè¿‡ç»Ÿä¸€çš„ API çš„é™æ€é‡åŒ–å’ŒåŠ¨æ€é‡åŒ–æ¥é‡åŒ–æ¨¡å‹ã€‚</p>
<p>åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œé¦–å…ˆä½¿ç”¨ ResNet18 ä½œä¸ºä¸€ä¸ªä¾‹å­æ¥å±•ç¤ºå¦‚ä½•ä½¿ç”¨ PyTorch Numeric Suite æ¥åº¦é‡é™æ€é‡åŒ–æ¨¡å‹å’Œæµ®ç‚¹æ¨¡å‹ä¹‹é—´çš„ç»Ÿè®¡ä¿¡æ¯ã€‚ç„¶åå°†ä»¥åŸºäº LSTM çš„åºåˆ—æ¨¡å‹ä¸ºä¾‹ï¼Œå±•ç¤º PyTorch Numeric Suite åœ¨åŠ¨æ€é‡åŒ–æ¨¡å‹ä¸­çš„åº”ç”¨ã€‚</p>
<section id="id1">
<h2>æ•°å€¼å¥—ä»¶ä¹‹é™æ€é‡åŒ–<a class="headerlink" href="#id1" title="æ°¸ä¹…é“¾æ¥è‡³æ ‡é¢˜">#</a></h2>
<p class="rubric">è®¾ç½®</p>
<p>ä»å¿…è¦çš„å¯¼å…¥å¼€å§‹ï¼š</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">absolute_import</span>
<span class="c1"># import numpy as np</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">import</span> <span class="nn">torchvision</span>
<span class="c1"># from torchvision import datasets</span>
<span class="c1"># import torchvision.transforms as transforms</span>
<span class="c1"># import os</span>
<span class="kn">import</span> <span class="nn">torch.quantization</span>
<span class="kn">import</span> <span class="nn">torch.quantization._numeric_suite</span> <span class="k">as</span> <span class="nn">ns</span>
<span class="kn">from</span> <span class="nn">torch.quantization</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">default_eval_fn</span><span class="p">,</span>
    <span class="n">default_qconfig</span><span class="p">,</span>
    <span class="n">quantize</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>ç„¶ååŠ è½½é¢„è®­ç»ƒçš„æµ®ç‚¹ ResNet18 æ¨¡å‹ï¼Œå°†å…¶é‡åŒ–ä¸º <code class="docutils literal notranslate"><span class="pre">qmodel</span></code>ã€‚æˆ‘ä»¬ä¸èƒ½æ¯”è¾ƒä¸¤ä¸ªä»»æ„çš„æ¨¡å‹ï¼Œåªèƒ½æ¯”è¾ƒä¸€ä¸ªæµ®ç‚¹æ¨¡å‹å’Œå®ƒæ´¾ç”Ÿçš„é‡åŒ–æ¨¡å‹ã€‚</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">float_model</span> <span class="o">=</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">quantization</span><span class="o">.</span><span class="n">resnet18</span><span class="p">(</span><span class="n">pretrained</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                       <span class="n">quantize</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">float_model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
<span class="n">float_model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<span class="n">float_model</span><span class="o">.</span><span class="n">fuse_model</span><span class="p">()</span>
<span class="n">float_model</span><span class="o">.</span><span class="n">qconfig</span> <span class="o">=</span> <span class="n">default_qconfig</span>
<span class="n">img_data</span> <span class="o">=</span> <span class="p">[(</span><span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">),</span>
             <span class="n">torch</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">))</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span>
<span class="n">qmodel</span> <span class="o">=</span> <span class="n">quantize</span><span class="p">(</span><span class="n">float_model</span><span class="p">,</span> <span class="n">default_eval_fn</span><span class="p">,</span> <span class="p">[</span><span class="n">img_data</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="id2">
<h3>1. æ¯”è¾ƒæµ®ç‚¹æ¨¡å‹å’Œé‡åŒ–æ¨¡å‹çš„æƒé‡<a class="headerlink" href="#id2" title="æ°¸ä¹…é“¾æ¥è‡³æ ‡é¢˜">#</a></h3>
<p>é¦–å…ˆè¦æ¯”è¾ƒçš„æ˜¯é‡åŒ–æ¨¡å‹å’Œæµ®ç‚¹æ¨¡å‹çš„æƒå€¼ã€‚å¯ä»¥ä» PyTorch Numeric Suite è°ƒç”¨ <code class="docutils literal notranslate"><span class="pre">compare_weights()</span></code> æ¥è·å¾—å­—å…¸ <code class="docutils literal notranslate"><span class="pre">wt_compare_dict</span></code>ï¼Œå…¶é”®å¯¹åº”äºæ¨¡å—åï¼Œæ¯ä¸ªæ¡ç›®éƒ½æ˜¯ä¸€ä¸ªå­—å…¸ï¼Œæœ‰ä¸¤ä¸ªé”® <code class="docutils literal notranslate"><span class="pre">'float'</span></code> å’Œ <code class="docutils literal notranslate"><span class="pre">'quantized'</span></code>ï¼ŒåŒ…å« float å’Œ quantized æƒé‡ã€‚<code class="docutils literal notranslate"><span class="pre">compare_weights()</span></code> æ¥å—æµ®ç‚¹å’Œé‡åŒ–çŠ¶æ€å­—å…¸å¹¶è¿”å›ä¸€ä¸ªå­—å…¸ï¼Œä¸æµ®ç‚¹æƒå€¼å¯¹åº”çš„é”®å’Œå€¼æ˜¯æµ®ç‚¹å’Œé‡åŒ–æƒå€¼çš„å­—å…¸ï¼š</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wt_compare_dict</span> <span class="o">=</span> <span class="n">ns</span><span class="o">.</span><span class="n">compare_weights</span><span class="p">(</span><span class="n">float_model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span>
                                     <span class="n">qmodel</span><span class="o">.</span><span class="n">state_dict</span><span class="p">())</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;`wt_compare_dict` é”®ï¼š&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">wt_compare_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">`wt_compare_dict` æ¡ç›®ä¸­ conv1 çš„æƒå€¼ï¼š&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">wt_compare_dict</span><span class="p">[</span><span class="s1">&#39;conv1.weight&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">wt_compare_dict</span><span class="p">[</span><span class="s1">&#39;conv1.weight&#39;</span><span class="p">][</span><span class="s1">&#39;float&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">wt_compare_dict</span><span class="p">[</span><span class="s1">&#39;conv1.weight&#39;</span><span class="p">][</span><span class="s1">&#39;quantized&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>`wt_compare_dict` é”®ï¼š
dict_keys([&#39;conv1.weight&#39;, &#39;layer1.0.conv1.weight&#39;, &#39;layer1.0.conv2.weight&#39;, &#39;layer1.1.conv1.weight&#39;, &#39;layer1.1.conv2.weight&#39;, &#39;layer2.0.conv1.weight&#39;, &#39;layer2.0.conv2.weight&#39;, &#39;layer2.0.downsample.0.weight&#39;, &#39;layer2.1.conv1.weight&#39;, &#39;layer2.1.conv2.weight&#39;, &#39;layer3.0.conv1.weight&#39;, &#39;layer3.0.conv2.weight&#39;, &#39;layer3.0.downsample.0.weight&#39;, &#39;layer3.1.conv1.weight&#39;, &#39;layer3.1.conv2.weight&#39;, &#39;layer4.0.conv1.weight&#39;, &#39;layer4.0.conv2.weight&#39;, &#39;layer4.0.downsample.0.weight&#39;, &#39;layer4.1.conv1.weight&#39;, &#39;layer4.1.conv2.weight&#39;, &#39;fc._packed_params._packed_params&#39;])

`wt_compare_dict` æ¡ç›®ä¸­ conv1 çš„æƒå€¼ï¼š
dict_keys([&#39;float&#39;, &#39;quantized&#39;])
torch.Size([64, 3, 7, 7])
torch.Size([64, 3, 7, 7])
</pre></div>
</div>
</div>
</div>
<p>ä¸€æ—¦è·å¾— <code class="docutils literal notranslate"><span class="pre">wt_compare_dict</span></code>ï¼Œç”¨æˆ·å°±å¯ä»¥ä»¥ä»»ä½•ä»–ä»¬æƒ³è¦çš„æ–¹å¼å¤„ç†è¿™ä¸ªå­—å…¸ã€‚ä»¥ float å’Œé‡åŒ–æ¨¡å‹æƒå€¼çš„é‡åŒ–è¯¯å·®ä¸ºä¾‹ï¼Œè®¡ç®—å¦‚ä¸‹ã€‚</p>
<p>è®¡ç®—é‡åŒ–å¼ é‡ <code class="docutils literal notranslate"><span class="pre">y</span></code> çš„ä¿¡å™ªæ¯”ï¼ˆSignal-to-Quantization-Noise Ratioï¼Œç®€ç§° SQNRï¼‰ï¼Œå®ƒåæ˜ äº†æœ€å¤§æ ‡ç§°ï¼ˆnominalï¼‰ä¿¡å·å¼ºåº¦ä¸é‡åŒ–ä¸­å¼•å…¥çš„é‡åŒ–è¯¯å·®ä¹‹é—´çš„å…³ç³»ã€‚æ›´é«˜çš„ SQNR å¯¹åº”æ›´ä½çš„é‡åŒ–è¯¯å·®ã€‚</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">compute_error</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="n">Ps</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">Pn</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">y</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">20</span><span class="o">*</span><span class="n">torch</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">Ps</span><span class="o">/</span><span class="n">Pn</span><span class="p">)</span>


<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">wt_compare_dict</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">key</span><span class="p">,</span>
          <span class="n">compute_error</span><span class="p">(</span><span class="n">wt_compare_dict</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;float&#39;</span><span class="p">],</span>
                        <span class="n">wt_compare_dict</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;quantized&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dequantize</span><span class="p">()))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>conv1.weight tensor(31.6638)
layer1.0.conv1.weight tensor(30.6450)
layer1.0.conv2.weight tensor(31.1528)
layer1.1.conv1.weight tensor(32.1438)
layer1.1.conv2.weight tensor(31.2477)
layer2.0.conv1.weight tensor(30.9890)
layer2.0.conv2.weight tensor(28.8233)
layer2.0.downsample.0.weight tensor(31.5558)
layer2.1.conv1.weight tensor(30.7668)
layer2.1.conv2.weight tensor(28.4516)
layer3.0.conv1.weight tensor(30.9247)
layer3.0.conv2.weight tensor(26.6841)
layer3.0.downsample.0.weight tensor(28.7825)
layer3.1.conv1.weight tensor(28.9707)
layer3.1.conv2.weight tensor(25.6785)
layer4.0.conv1.weight tensor(26.8496)
layer4.0.conv2.weight tensor(25.8396)
layer4.0.downsample.0.weight tensor(28.6355)
layer4.1.conv1.weight tensor(26.8759)
layer4.1.conv2.weight tensor(28.4319)
fc._packed_params._packed_params tensor(32.6506)
</pre></div>
</div>
</div>
</div>
<p>å¦ä¸€ä¸ªä¾‹å­ <code class="docutils literal notranslate"><span class="pre">wt_compare_dict</span></code> ä¹Ÿå¯ä»¥ç”¨æ¥ç»˜åˆ¶æµ®ç‚¹å’Œé‡åŒ–æ¨¡å‹çš„æƒå€¼ç›´æ–¹å›¾ã€‚</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="n">f</span> <span class="o">=</span> <span class="n">wt_compare_dict</span><span class="p">[</span><span class="s1">&#39;conv1.weight&#39;</span><span class="p">][</span><span class="s1">&#39;float&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Floating point model weights of conv1&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">q</span> <span class="o">=</span> <span class="n">wt_compare_dict</span><span class="p">[</span><span class="s1">&#39;conv1.weight&#39;</span><span class="p">][</span><span class="s1">&#39;quantized&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">dequantize</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Quantized model weights of conv1&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/f1509d037794bf282bebf7ee3f669045510037692621fcd8fdbe96d327843d8c.png" src="../../_images/f1509d037794bf282bebf7ee3f669045510037692621fcd8fdbe96d327843d8c.png" />
<img alt="../../_images/d306cdd5c2e0cf57c11c1ac60c7e54b8a4fbebaf28b31388c460086818c9cb97.png" src="../../_images/d306cdd5c2e0cf57c11c1ac60c7e54b8a4fbebaf28b31388c460086818c9cb97.png" />
</div>
</div>
</section>
<section id="id3">
<h3>2. æ¯”è¾ƒæµ®ç‚¹å’Œé‡åŒ–æ¨¡å‹åœ¨ç›¸åº”çš„ä½ç½®<a class="headerlink" href="#id3" title="æ°¸ä¹…é“¾æ¥è‡³æ ‡é¢˜">#</a></h3>
<p>ç¬¬äºŒä¸ªå·¥å…·å…è®¸å¯¹ç›¸åŒè¾“å…¥åœ¨ç›¸åº”ä½ç½®ä¸Šçš„æµ®ç‚¹æ¨¡å‹å’Œé‡åŒ–æ¨¡å‹ä¹‹é—´çš„æƒé‡å’Œæ¿€æ´»è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚çº¢è‰²ç®­å¤´è¡¨ç¤ºæ¯”è¾ƒçš„ä½ç½®ã€‚</p>
<figure class="align-default">
<img alt="../../_images/compare_output.png" src="../../_images/compare_output.png" />
</figure>
<p>æˆ‘ä»¬ä» PyTorch Numeric Suite è°ƒç”¨ <code class="docutils literal notranslate"><span class="pre">compare_model_outputs()</span></code> æ¥è·å–ç»™å®šè¾“å…¥æ•°æ®å¯¹åº”ä½ç½®çš„æµ®ç‚¹æ¨¡å‹å’Œé‡åŒ–æ¨¡å‹ä¸­çš„æ¿€æ´»ã€‚è¿™ä¸ª API è¿”å›ä¸€ä¸ªå­—å…¸ï¼Œå…¶ä¸­æ¨¡å—åä¸ºé”®ã€‚æ¯ä¸ªæ¡ç›®æœ¬èº«æ˜¯ä¸€ä¸ªå­—å…¸ï¼Œæœ‰ä¸¤ä¸ªåŒ…å«æ¿€æ´»çš„é”® â€˜floatâ€™ å’Œ â€˜quantizedâ€™ã€‚</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">img_data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># æ¥å—æµ®ç‚¹å’Œé‡åŒ–æ¨¡å‹ä»¥åŠè¾“å…¥æ•°æ®ï¼Œå¹¶è¿”å›ä¸€ä¸ªå­—å…¸ï¼Œå…¶é”®å¯¹åº”äºé‡åŒ–æ¨¡å—åç§°ï¼Œ</span>
<span class="c1"># æ¯ä¸ªæ¡ç›®æ˜¯ä¸€ä¸ªå­—å…¸ï¼Œæœ‰ä¸¤ä¸ªé”®&#39;float&#39;å’Œ&#39;quantized&#39;ï¼ŒåŒ…å«åŒ¹é…ä½ç½®ä¸Šçš„æµ®ç‚¹å’Œé‡åŒ–æ¨¡å‹çš„æ¿€æ´»ã€‚</span>
<span class="n">act_compare_dict</span> <span class="o">=</span> <span class="n">ns</span><span class="o">.</span><span class="n">compare_model_outputs</span><span class="p">(</span><span class="n">float_model</span><span class="p">,</span> <span class="n">qmodel</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;keys of act_compare_dict:&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">act_compare_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">keys of act_compare_dict entry for conv1&#39;s output:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">act_compare_dict</span><span class="p">[</span><span class="s1">&#39;conv1.stats&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">act_compare_dict</span><span class="p">[</span><span class="s1">&#39;conv1.stats&#39;</span><span class="p">][</span><span class="s1">&#39;float&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">act_compare_dict</span><span class="p">[</span><span class="s1">&#39;conv1.stats&#39;</span><span class="p">][</span><span class="s1">&#39;quantized&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>è¯¥å­—å…¸å¯ç”¨äºæ¯”è¾ƒå’Œè®¡ç®— float å’Œé‡åŒ–æ¨¡å‹æ¿€æ´»çš„é‡åŒ–è¯¯å·®ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">act_compare_dict</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">key</span><span class="p">,</span>
          <span class="n">compute_error</span><span class="p">(</span><span class="n">act_compare_dict</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;float&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">act_compare_dict</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;quantized&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dequantize</span><span class="p">()))</span>
</pre></div>
</div>
</div>
</div>
<p>å¦‚æœå¸Œæœ›å¯¹å¤šä¸ªè¾“å…¥æ•°æ®è¿›è¡Œæ¯”è¾ƒï¼Œå¯ä»¥æ‰§è¡Œä»¥ä¸‹æ“ä½œã€‚é€šè¿‡å°† logger é™„åŠ åˆ°æµ®ç‚¹æ¨¡å—å’Œé‡åŒ–æ¨¡å—ï¼ˆå¦‚æœå®ƒä»¬åœ¨ <code class="docutils literal notranslate"><span class="pre">white_list</span></code> ä¸­ï¼‰æ¥å‡†å¤‡æ¨¡å‹ã€‚é»˜è®¤çš„ logger ä¸º <code class="docutils literal notranslate"><span class="pre">OutputLogger</span></code>ï¼Œé»˜è®¤çš„ <code class="docutils literal notranslate"><span class="pre">white_list</span></code> ä¸º <code class="docutils literal notranslate"><span class="pre">DEFAULT_NUMERIC_SUITE_COMPARE_MODEL_OUTPUT_WHITE_LIST</span></code>ã€‚</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ns</span><span class="o">.</span><span class="n">prepare_model_outputs</span><span class="p">(</span><span class="n">float_model</span><span class="p">,</span> <span class="n">qmodel</span><span class="p">)</span>

<span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">img_data</span><span class="p">:</span>
    <span class="n">float_model</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">qmodel</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="c1"># æŸ¥æ‰¾æµ®ç‚¹å’Œé‡åŒ–æ¨¡å—ä¹‹é—´çš„åŒ¹é…æ¿€æ´»ï¼Œå¹¶è¿”å›ä¸€ä¸ªå­—å…¸ï¼Œå…¶é”®å¯¹åº”äºé‡åŒ–æ¨¡å—åç§°ï¼Œ</span>
<span class="c1"># æ¯ä¸ªæ¡ç›®æ˜¯ä¸€ä¸ªå­—å…¸ï¼Œæœ‰ä¸¤ä¸ªé”®&#39;float&#39;å’Œ&#39;quantized&#39;ï¼ŒåŒ…å«ç”±è®°å½•å™¨è®°å½•çš„åŒ¹é…æµ®ç‚¹å’Œé‡åŒ–æ¿€æ´»</span>
<span class="n">act_compare_dict</span> <span class="o">=</span> <span class="n">ns</span><span class="o">.</span><span class="n">get_matching_activations</span><span class="p">(</span><span class="n">float_model</span><span class="p">,</span> <span class="n">qmodel</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>ä¸Šè¿° API ä¸­ä½¿ç”¨çš„é»˜è®¤ logger æ˜¯ <code class="docutils literal notranslate"><span class="pre">OutputLogger</span></code>ï¼Œç”¨äº log æ¨¡å—çš„è¾“å‡ºã€‚æˆ‘ä»¬å¯ä»¥ç»§æ‰¿åŸºç±» <code class="docutils literal notranslate"><span class="pre">Logger</span></code>ï¼Œå¹¶åˆ›å»ºè‡ªå·±çš„ logger æ¥æ‰§è¡Œä¸åŒçš„åŠŸèƒ½ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªæ–°çš„ <code class="docutils literal notranslate"><span class="pre">MyOutputLogger</span></code> ç±»ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyOutputLogger</span><span class="p">(</span><span class="n">ns</span><span class="o">.</span><span class="n">Logger</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Customized logger class</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MyOutputLogger</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="c1"># Custom functionalities</span>
        <span class="c1"># ...</span>
        <span class="k">return</span> <span class="n">x</span>
</pre></div>
</div>
</div>
</div>
<p>ç„¶åæˆ‘ä»¬å¯ä»¥æŠŠè¿™ä¸ªè®°å½•å™¨ä¼ é€’åˆ°ä¸Šé¢çš„ API ä¸­ï¼Œæ¯”å¦‚ï¼š</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">img_data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">act_compare_dict</span> <span class="o">=</span> <span class="n">ns</span><span class="o">.</span><span class="n">compare_model_outputs</span><span class="p">(</span><span class="n">float_model</span><span class="p">,</span>
                                            <span class="n">qmodel</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span>
                                            <span class="n">logger_cls</span><span class="o">=</span><span class="n">MyOutputLogger</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>æˆ–è€…ï¼š</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ns</span><span class="o">.</span><span class="n">prepare_model_outputs</span><span class="p">(</span><span class="n">float_model</span><span class="p">,</span> <span class="n">qmodel</span><span class="p">,</span> <span class="n">MyOutputLogger</span><span class="p">)</span>
<span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">img_data</span><span class="p">:</span>
    <span class="n">float_model</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">qmodel</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">act_compare_dict</span> <span class="o">=</span> <span class="n">ns</span><span class="o">.</span><span class="n">get_matching_activations</span><span class="p">(</span><span class="n">float_model</span><span class="p">,</span> <span class="n">qmodel</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id4">
<h3>3. ä½¿ç”¨ç›¸åŒçš„è¾“å…¥æ•°æ®ï¼Œå°†é‡åŒ–æ¨¡å‹ä¸­çš„æ¨¡å—ä¸ç­‰æ•ˆçš„æµ®ç‚¹æ¨¡å—è¿›è¡Œæ¯”è¾ƒ<a class="headerlink" href="#id4" title="æ°¸ä¹…é“¾æ¥è‡³æ ‡é¢˜">#</a></h3>
<p>ç¬¬ä¸‰ä¸ªå·¥å…·å…è®¸æ¯”è¾ƒæ¨¡å‹ä¸­çš„é‡åŒ–æ¨¡å—å’Œå¯¹åº”çš„æµ®ç‚¹æ¨¡å—ï¼Œä¸ºå®ƒä»¬æä¾›ç›¸åŒçš„è¾“å…¥ï¼Œå¹¶æ¯”è¾ƒå®ƒä»¬çš„è¾“å‡ºï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure class="align-default">
<img alt="../../_images/compare_stub.png" src="../../_images/compare_stub.png" />
</figure>
<p>åœ¨å®è·µä¸­ï¼Œæˆ‘ä»¬è°ƒç”¨ <code class="docutils literal notranslate"><span class="pre">prepare_model_with_stub()</span></code> æ¥äº¤æ¢æˆ‘ä»¬æƒ³è¦æ¯”è¾ƒçš„é‡åŒ–æ¨¡å—ä¸ <code class="docutils literal notranslate"><span class="pre">Shadow</span></code> æ¨¡å—ï¼Œå¦‚ä¸‹æ‰€ç¤º:</p>
<figure class="align-default">
<img alt="../../_images/shadow.png" src="../../_images/shadow.png" />
</figure>
<p><code class="docutils literal notranslate"><span class="pre">Shadow</span></code> æ¨¡å—ä»¥é‡åŒ–æ¨¡å—ã€æµ®ç‚¹æ¨¡å—å’Œ logger ä½œä¸ºè¾“å…¥ï¼Œå¹¶åœ¨å…¶ä¸­åˆ›å»º forward è·¯å¾„ï¼Œä½¿æµ®ç‚¹æ¨¡å—ä¸ shadow é‡åŒ–æ¨¡å—å…±äº«åŒè¾“å…¥å¼ é‡ã€‚</p>
<p>logger å¯ä»¥è‡ªå®šä¹‰ï¼Œé»˜è®¤çš„è®°å½•å™¨æ˜¯ <code class="docutils literal notranslate"><span class="pre">ShadowLogger</span></code>ï¼Œå®ƒå°†ä¿å­˜é‡åŒ–æ¨¡å—å’Œæµ®ç‚¹æ¨¡å—çš„è¾“å‡ºï¼Œç”¨äºè®¡ç®—æ¨¡å—çº§é‡åŒ–è¯¯å·®ã€‚</p>
<p>æ³¨æ„ï¼Œåœ¨æ¯æ¬¡è°ƒç”¨ <code class="docutils literal notranslate"><span class="pre">compare_model_outputs()</span></code> å’Œ <code class="docutils literal notranslate"><span class="pre">compare_model_stub()</span></code> ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦æœ‰å¹²å‡€çš„æµ®ç‚¹å’Œé‡åŒ–æ¨¡å‹ã€‚è¿™æ˜¯å› ä¸º <code class="docutils literal notranslate"><span class="pre">compare_model_outputs()</span></code> å’Œ <code class="docutils literal notranslate"><span class="pre">compare_model_stub()</span></code> å¯¹ float å’Œé‡åŒ–æ¨¡å‹è¿›è¡Œäº†åŸåœ°ä¿®æ”¹ï¼Œå¦‚æœä¸€ä¸ªæ¥ä¸€ä¸ªåœ°è°ƒç”¨ï¼Œå°†å¯¼è‡´æ„æƒ³ä¸åˆ°çš„ç»“æœã€‚</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">float_model</span> <span class="o">=</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">quantization</span><span class="o">.</span><span class="n">resnet18</span><span class="p">(</span><span class="n">pretrained</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">quantize</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">float_model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
<span class="n">float_model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<span class="n">float_model</span><span class="o">.</span><span class="n">fuse_model</span><span class="p">()</span>
<span class="n">float_model</span><span class="o">.</span><span class="n">qconfig</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">quantization</span><span class="o">.</span><span class="n">default_qconfig</span>
<span class="n">img_data</span> <span class="o">=</span> <span class="p">[(</span><span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">))</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span>
<span class="n">qmodel</span> <span class="o">=</span> <span class="n">quantize</span><span class="p">(</span><span class="n">float_model</span><span class="p">,</span> <span class="n">default_eval_fn</span><span class="p">,</span> <span class="p">[</span><span class="n">img_data</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>åœ¨ä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬è°ƒç”¨ PyTorch æ•°å€¼å¥—ä»¶ä¸­çš„  <code class="docutils literal notranslate"><span class="pre">compare_model_stub()</span></code> æ¥æ¯”è¾ƒ <code class="docutils literal notranslate"><span class="pre">QuantizableBasicBlock</span></code> æ¨¡å—å’Œå®ƒçš„æµ®ç‚¹æ•°ç­‰æ•ˆå€¼ã€‚è¿™ä¸ª API è¿”å›å­—å…¸ï¼Œå…¶é”®å¯¹åº”äºæ¨¡å—åï¼Œæ¯ä¸ªæ¡ç›®éƒ½æ˜¯ä¸€ä¸ªå­—å…¸ï¼Œæœ‰ä¸¤ä¸ªé”® â€˜floatâ€™ å’Œ â€˜quantizedâ€™ï¼ŒåŒ…å« quantized åŠå…¶åŒ¹é…çš„æµ®ç‚¹é˜´å½±æ¨¡å—çš„è¾“å‡ºå¼ é‡ã€‚</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">img_data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">module_swap_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">torchvision</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">quantization</span><span class="o">.</span><span class="n">resnet</span><span class="o">.</span><span class="n">QuantizableBasicBlock</span><span class="p">]</span>

<span class="c1"># Takes in floating point and quantized model as well as input data, and returns a dict with key</span>
<span class="c1"># corresponding to module names and each entry being a dictionary with two keys &#39;float&#39; and</span>
<span class="c1"># &#39;quantized&#39;, containing the output tensors of quantized module and its matching floating point shadow module.</span>
<span class="n">ob_dict</span> <span class="o">=</span> <span class="n">ns</span><span class="o">.</span><span class="n">compare_model_stub</span><span class="p">(</span><span class="n">float_model</span><span class="p">,</span> <span class="n">qmodel</span><span class="p">,</span> <span class="n">module_swap_list</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;keys of ob_dict:&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ob_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">keys of ob_dict entry for layer1.0&#39;s output:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ob_dict</span><span class="p">[</span><span class="s1">&#39;layer1.0.stats&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ob_dict</span><span class="p">[</span><span class="s1">&#39;layer1.0.stats&#39;</span><span class="p">][</span><span class="s1">&#39;float&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ob_dict</span><span class="p">[</span><span class="s1">&#39;layer1.0.stats&#39;</span><span class="p">][</span><span class="s1">&#39;quantized&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>è¿™ä¸ªå­—å…¸å¯ä»¥ç”¨æ¥æ¯”è¾ƒå’Œè®¡ç®—æ¨¡å—çº§é‡åŒ–è¯¯å·®ã€‚</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">ob_dict</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">compute_error</span><span class="p">(</span><span class="n">ob_dict</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;float&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">ob_dict</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;quantized&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dequantize</span><span class="p">()))</span>
</pre></div>
</div>
</div>
</div>
<p>å¦‚æœå¸Œæœ›å¯¹å¤šä¸ªè¾“å…¥æ•°æ®è¿›è¡Œæ¯”è¾ƒï¼Œå¯ä»¥æ‰§è¡Œä»¥ä¸‹æ“ä½œã€‚</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ns</span><span class="o">.</span><span class="n">prepare_model_with_stubs</span><span class="p">(</span><span class="n">float_model</span><span class="p">,</span> <span class="n">qmodel</span><span class="p">,</span> <span class="n">module_swap_list</span><span class="p">,</span> <span class="n">ns</span><span class="o">.</span><span class="n">ShadowLogger</span><span class="p">)</span>
<span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">img_data</span><span class="p">:</span>
    <span class="n">qmodel</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">ob_dict</span> <span class="o">=</span> <span class="n">ns</span><span class="o">.</span><span class="n">get_logger_dict</span><span class="p">(</span><span class="n">qmodel</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>åœ¨ä¸Šè¿° API ä¸­ä½¿ç”¨çš„é»˜è®¤è®°å½•å™¨æ˜¯ <code class="docutils literal notranslate"><span class="pre">ShadowLogger</span></code>ï¼Œç”¨äºè®°å½•é‡åŒ–æ¨¡å—åŠå…¶åŒ¹é…çš„æµ®åŠ¨é˜´å½±æ¨¡å—çš„è¾“å‡ºã€‚æˆ‘ä»¬å¯ä»¥ç»§æ‰¿åŸºç±» <code class="docutils literal notranslate"><span class="pre">Logger</span></code>ï¼Œå¹¶åˆ›å»ºè‡ªå·±çš„ Logger æ¥æ‰§è¡Œä¸åŒçš„åŠŸèƒ½ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºæ–°çš„ <code class="docutils literal notranslate"><span class="pre">MyShadowLogger</span></code> ç±»ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyShadowLogger</span><span class="p">(</span><span class="n">ns</span><span class="o">.</span><span class="n">Logger</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Customized logger class</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MyShadowLogger</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="c1"># Custom functionalities</span>
        <span class="c1"># ...</span>
        <span class="k">return</span> <span class="n">x</span>
</pre></div>
</div>
</div>
</div>
<p>ç„¶åæˆ‘ä»¬å¯ä»¥æŠŠè¿™ä¸ªè®°å½•å™¨ä¼ é€’åˆ°ä¸Šé¢çš„ API ä¸­ï¼Œæ¯”å¦‚ï¼š</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">img_data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">ob_dict</span> <span class="o">=</span> <span class="n">ns</span><span class="o">.</span><span class="n">compare_model_stub</span><span class="p">(</span><span class="n">float_model</span><span class="p">,</span> <span class="n">qmodel</span><span class="p">,</span> <span class="n">module_swap_list</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">logger_cls</span><span class="o">=</span><span class="n">MyShadowLogger</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>æˆ–è€…ï¼š</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ns</span><span class="o">.</span><span class="n">prepare_model_with_stubs</span><span class="p">(</span><span class="n">float_model</span><span class="p">,</span> <span class="n">qmodel</span><span class="p">,</span> <span class="n">module_swap_list</span><span class="p">,</span> <span class="n">MyShadowLogger</span><span class="p">)</span>
<span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">img_data</span><span class="p">:</span>
    <span class="n">qmodel</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">ob_dict</span> <span class="o">=</span> <span class="n">ns</span><span class="o">.</span><span class="n">get_logger_dict</span><span class="p">(</span><span class="n">qmodel</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="numeric-suite">
<h2>Numeric Suite ä¹‹åŠ¨æ€é‡åŒ–<a class="headerlink" href="#numeric-suite" title="æ°¸ä¹…é“¾æ¥è‡³æ ‡é¢˜">#</a></h2>
<p>Numeric Suite APIs are designed in such as way that they work for both dynamic quantized model and static quantized model. We will use a model with both LSTM and Linear modules to demonstrate the usage of Numeric Suite on dynamic quantized model. This model is the same one used in the tutorial of dynamic quantization on LSTM word language model <a class="footnote-reference brackets" href="#id8" id="id5">1</a>.</p>
<section id="id6">
<h3>è®¾ç½®<a class="headerlink" href="#id6" title="æ°¸ä¹…é“¾æ¥è‡³æ ‡é¢˜">#</a></h3>
<p>First we define the model as below. Notice that within this model only <code class="docutils literal notranslate"><span class="pre">nn.LSTM</span></code> and <code class="docutils literal notranslate"><span class="pre">nn.Linear</span></code> modules will be quantized dynamically and <code class="docutils literal notranslate"><span class="pre">nn.Embedding</span></code> will remain as floating point module after quantization.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">LSTMModel</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Container module with an encoder, a recurrent module, and a decoder.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ntoken</span><span class="p">,</span> <span class="n">ninp</span><span class="p">,</span> <span class="n">nhid</span><span class="p">,</span> <span class="n">nlayers</span><span class="p">,</span> <span class="n">dropout</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">LSTMModel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">ntoken</span><span class="p">,</span> <span class="n">ninp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rnn</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span><span class="n">ninp</span><span class="p">,</span> <span class="n">nhid</span><span class="p">,</span> <span class="n">nlayers</span><span class="p">,</span> <span class="n">dropout</span><span class="o">=</span><span class="n">dropout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">nhid</span><span class="p">,</span> <span class="n">ntoken</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_weights</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nhid</span> <span class="o">=</span> <span class="n">nhid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nlayers</span> <span class="o">=</span> <span class="n">nlayers</span>

    <span class="k">def</span> <span class="nf">init_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">initrange</span> <span class="o">=</span> <span class="mf">0.1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">uniform_</span><span class="p">(</span><span class="o">-</span><span class="n">initrange</span><span class="p">,</span> <span class="n">initrange</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">zero_</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">uniform_</span><span class="p">(</span><span class="o">-</span><span class="n">initrange</span><span class="p">,</span> <span class="n">initrange</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="n">hidden</span><span class="p">):</span>
        <span class="n">emb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
        <span class="n">output</span><span class="p">,</span> <span class="n">hidden</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rnn</span><span class="p">(</span><span class="n">emb</span><span class="p">,</span> <span class="n">hidden</span><span class="p">)</span>
        <span class="n">decoded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">decoded</span><span class="p">,</span> <span class="n">hidden</span>

    <span class="k">def</span> <span class="nf">init_hidden</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bsz</span><span class="p">):</span>
        <span class="n">weight</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">weight</span><span class="o">.</span><span class="n">new_zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nlayers</span><span class="p">,</span> <span class="n">bsz</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nhid</span><span class="p">),</span>
                <span class="n">weight</span><span class="o">.</span><span class="n">new_zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nlayers</span><span class="p">,</span> <span class="n">bsz</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nhid</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>Then we create the <code class="docutils literal notranslate"><span class="pre">float_model</span></code> and quantize it into qmodel.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ntokens</span> <span class="o">=</span> <span class="mi">10</span>

<span class="n">float_model</span> <span class="o">=</span> <span class="n">LSTMModel</span><span class="p">(</span>
    <span class="n">ntoken</span> <span class="o">=</span> <span class="n">ntokens</span><span class="p">,</span>
    <span class="n">ninp</span> <span class="o">=</span> <span class="mi">512</span><span class="p">,</span>
    <span class="n">nhid</span> <span class="o">=</span> <span class="mi">256</span><span class="p">,</span>
    <span class="n">nlayers</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">float_model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>

<span class="n">qmodel</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">quantization</span><span class="o">.</span><span class="n">quantize_dynamic</span><span class="p">(</span>
    <span class="n">float_model</span><span class="p">,</span> <span class="p">{</span><span class="n">nn</span><span class="o">.</span><span class="n">LSTM</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">},</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">qint8</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="compare-the-weights-of-float-and-quantized-models">
<h3>1. Compare the weights of float and quantized models<a class="headerlink" href="#compare-the-weights-of-float-and-quantized-models" title="æ°¸ä¹…é“¾æ¥è‡³æ ‡é¢˜">#</a></h3>
<p>We first call <code class="docutils literal notranslate"><span class="pre">compare_weights()</span></code> from PyTorch Numeric Suite to get a dictionary <code class="docutils literal notranslate"><span class="pre">wt_compare_dict</span></code> with key corresponding to module names and each entry is a dictionary with two keys â€˜floatâ€™ and â€˜quantizedâ€™, containing the float and quantized weights.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wt_compare_dict</span> <span class="o">=</span> <span class="n">ns</span><span class="o">.</span><span class="n">compare_weights</span><span class="p">(</span><span class="n">float_model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="n">qmodel</span><span class="o">.</span><span class="n">state_dict</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
<p>Once we get <code class="docutils literal notranslate"><span class="pre">wt_compare_dict</span></code>, it can be used to compare and compute the quantization error of the weights of float and quantized models as following.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">wt_compare_dict</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">wt_compare_dict</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;quantized&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">is_quantized</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">compute_error</span><span class="p">(</span><span class="n">wt_compare_dict</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;float&#39;</span><span class="p">],</span> <span class="n">wt_compare_dict</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;quantized&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dequantize</span><span class="p">()))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">compute_error</span><span class="p">(</span><span class="n">wt_compare_dict</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;float&#39;</span><span class="p">],</span> <span class="n">wt_compare_dict</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;quantized&#39;</span><span class="p">]))</span>
</pre></div>
</div>
</div>
</div>
<p>The Inf value in <code class="docutils literal notranslate"><span class="pre">encoder.weight</span></code> entry above is because encoder module is not quantized and the weights are the same in both floating point and quantized models.</p>
</section>
<section id="compare-float-point-and-quantized-models-at-corresponding-locations">
<h3>2. Compare float point and quantized models at corresponding locations<a class="headerlink" href="#compare-float-point-and-quantized-models-at-corresponding-locations" title="æ°¸ä¹…é“¾æ¥è‡³æ ‡é¢˜">#</a></h3>
<p>Then we call <code class="docutils literal notranslate"><span class="pre">compare_model_outputs()</span></code> from PyTorch Numeric Suite to get the activations in float model and quantized model at corresponding locations for the given input data. This API returns a dict with module names being keys. Each entry is itself a dict with two keys â€˜floatâ€™ and â€˜quantizedâ€™ containing the activations. Notice that this sequence model has two inputs, and we can pass both inputs into <code class="docutils literal notranslate"><span class="pre">compare_model_outputs()</span></code> and <code class="docutils literal notranslate"><span class="pre">compare_model_stub()</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">input_</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">ntokens</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">)</span>
<span class="n">hidden</span> <span class="o">=</span> <span class="n">float_model</span><span class="o">.</span><span class="n">init_hidden</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">act_compare_dict</span> <span class="o">=</span> <span class="n">ns</span><span class="o">.</span><span class="n">compare_model_outputs</span><span class="p">(</span><span class="n">float_model</span><span class="p">,</span> <span class="n">qmodel</span><span class="p">,</span> <span class="n">input_</span><span class="p">,</span> <span class="n">hidden</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">act_compare_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
<p>This dict can be used to compare and compute the quantization error of the activations of float and quantized models as following. The LSTM module in this model has two outputs, in this example we compute the error of the first output.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">act_compare_dict</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">compute_error</span><span class="p">(</span><span class="n">act_compare_dict</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;float&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">act_compare_dict</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;quantized&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="compare-a-module-in-a-quantized-model-with-its-float-point-equivalent-with-the-same-input-data">
<h3>3. Compare a module in a quantized model with its float point equivalent, with the same input data<a class="headerlink" href="#compare-a-module-in-a-quantized-model-with-its-float-point-equivalent-with-the-same-input-data" title="æ°¸ä¹…é“¾æ¥è‡³æ ‡é¢˜">#</a></h3>
<p>Next we call <code class="docutils literal notranslate"><span class="pre">compare_model_stub()</span></code> from PyTorch Numeric Suite to compare LSTM and Linear module with its float point equivalent. This API returns a dict with key corresponding to module names and each entry being a dictionary with two keys â€˜floatâ€™ and â€˜quantizedâ€™, containing the output tensors of quantized and its matching float shadow module.</p>
<p>We reset the model first.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">float_model</span> <span class="o">=</span> <span class="n">LSTMModel</span><span class="p">(</span>
    <span class="n">ntoken</span> <span class="o">=</span> <span class="n">ntokens</span><span class="p">,</span>
    <span class="n">ninp</span> <span class="o">=</span> <span class="mi">512</span><span class="p">,</span>
    <span class="n">nhid</span> <span class="o">=</span> <span class="mi">256</span><span class="p">,</span>
    <span class="n">nlayers</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">float_model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>

<span class="n">qmodel</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">quantization</span><span class="o">.</span><span class="n">quantize_dynamic</span><span class="p">(</span>
    <span class="n">float_model</span><span class="p">,</span> <span class="p">{</span><span class="n">nn</span><span class="o">.</span><span class="n">LSTM</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">},</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">qint8</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Next we call <code class="docutils literal notranslate"><span class="pre">compare_model_stub()</span></code> from PyTorch Numeric Suite to compare LSTM and Linear module with its float point equivalent. This API returns a dict with key corresponding to module names and each entry being a dictionary with two keys â€˜floatâ€™ and â€˜quantizedâ€™, containing the output tensors of quantized and its matching float shadow module.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">module_swap_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">LSTM</span><span class="p">]</span>
<span class="n">ob_dict</span> <span class="o">=</span> <span class="n">ns</span><span class="o">.</span><span class="n">compare_model_stub</span><span class="p">(</span><span class="n">float_model</span><span class="p">,</span> <span class="n">qmodel</span><span class="p">,</span> <span class="n">module_swap_list</span><span class="p">,</span> <span class="n">input_</span><span class="p">,</span> <span class="n">hidden</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ob_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
<p>This dict can be then used to compare and compute the module level quantization error.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">ob_dict</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">compute_error</span><span class="p">(</span><span class="n">ob_dict</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;float&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">ob_dict</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;quantized&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
</pre></div>
</div>
</div>
</div>
<p>40db çš„ SQNR æ˜¯å¾ˆé«˜çš„ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åœ¨æµ®ç‚¹å’Œé‡åŒ–æ¨¡å‹ä¹‹é—´æœ‰å¾ˆå¥½çš„æ•°å€¼å¯¹é½ã€‚</p>
</section>
</section>
<section id="id7">
<h2>ç»“è®º<a class="headerlink" href="#id7" title="æ°¸ä¹…é“¾æ¥è‡³æ ‡é¢˜">#</a></h2>
<p>åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬æ¼”ç¤ºäº†å¦‚ä½•ä½¿ç”¨ PyTorch Numeric Suite æ¥åº¦é‡é‡åŒ–æ¨¡å‹å’Œæµ®ç‚¹æ¨¡å‹ä¹‹é—´çš„ç»Ÿè®¡æ•°æ®ï¼Œå¹¶ä½¿ç”¨ç”¨äºé™æ€é‡åŒ–å’ŒåŠ¨æ€é‡åŒ–çš„ç»Ÿä¸€ API åœ¨å³æ—¶æ¨¡å¼ä¸‹è¿›è¡Œæ¯”è¾ƒã€‚
æ„Ÿè°¢ä½ çš„é˜…è¯»!ä¸€å¦‚æ—¢å¾€ï¼Œæˆ‘ä»¬æ¬¢è¿ä»»ä½•åé¦ˆï¼Œæ‰€ä»¥å¦‚æœæ‚¨æœ‰ä»»ä½•é—®é¢˜ï¼Œè¯·åˆ›å»º <a class="reference external" href="https://github.com/pytorch/pytorch/issues">issue</a>ã€‚</p>
<hr class="footnotes docutils" />
<dl class="footnote brackets">
<dt class="label" id="id8"><span class="brackets"><a class="fn-backref" href="#id5">1</a></span></dt>
<dd><p><a class="reference external" href="https://pytorch.org/tutorials/advanced/dynamic_quantization_tutorial.html">DYNAMIC QUANTIZATION ON AN LSTM WORD LANGUAGE MODEL</a>.</p>
</dd>
</dl>
</section>
</section>

<div class="section">
   
</div>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="basic.html" title="ä¸Šä¸€é¡µ é¡µ">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">ä¸Šä¸€é¡µ</p>
            <p class="prev-next-title">åŸºç¡€</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="../study/index.html" title="ä¸‹ä¸€é¡µ é¡µ">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">ä¸‹ä¸€é¡µ</p>
        <p class="prev-next-title">å­¦ä¹ </p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By xinetzone<br/>
  
      &copy; Copyright 2021, xinetzone.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>