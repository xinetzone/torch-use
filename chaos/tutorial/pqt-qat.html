
<!DOCTYPE html>

<html lang="zh_CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>PTQ ä¸ QAT å®è·µ &#8212; torch-book 0.0.1 æ–‡æ¡£</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" href="../../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/tabs.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/default.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/tabs.js"></script>
    <script async="async" kind="hypothesis" src="https://hypothes.is/embed.js"></script>
    <script kind="utterances">

    var commentsRunWhenDOMLoaded = cb => {
    if (document.readyState != 'loading') {
        cb()
    } else if (document.addEventListener) {
        document.addEventListener('DOMContentLoaded', cb)
    } else {
        document.attachEvent('onreadystatechange', function() {
        if (document.readyState == 'complete') cb()
        })
    }
}

var addUtterances = () => {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src = "https://utteranc.es/client.js";
    script.async = "async";

    script.setAttribute("repo", "xinetzone/torch-book");
    script.setAttribute("issue-term", "pathname");
    script.setAttribute("theme", "github-light");
    script.setAttribute("label", "ğŸ’¬ comment");
    script.setAttribute("crossorigin", "anonymous");

    sections = document.querySelectorAll("div.section");
    if (sections !== null) {
        section = sections[sections.length-1];
        section.appendChild(script);
    }
}
commentsRunWhenDOMLoaded(addUtterances);
</script>
    <script src="../../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script src="../../_static/translations.js"></script>
    <script src="../../_static/design-tabs.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({startOnLoad:true});</script>
    <link rel="canonical" href="https://xinetzone.github.io/torch-book/chaos/tutorial/pqt-qat.html" />
    <link rel="shortcut icon" href="../../_static/favicon.jpg"/>
    <link rel="index" title="ç´¢å¼•" href="../../genindex.html" />
    <link rel="search" title="æœç´¢" href="../../search.html" /> 
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="zh_CN">
    

    <!-- Google Analytics -->
     
<link
  rel="alternate"
  type="application/atom+xml"
  href="../../posts/atom.xml"
  title="Blog"
/>
 
<style type="text/css">
  ul.ablog-archive {
    list-style: none;
    overflow: auto;
    margin-left: 0px;
  }
  ul.ablog-archive li {
    float: left;
    margin-right: 5px;
    font-size: 80%;
  }
  ul.postlist a {
    font-style: italic;
  }
  ul.postlist-style-disc {
    list-style-type: disc;
  }
  ul.postlist-style-none {
    list-style-type: none;
  }
  ul.postlist-style-circle {
    list-style-type: circle;
  }
</style>

  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../../_static/logo.jpg" class="logo" alt="logo">
      
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../intro.html">
   é¡¹ç›®ç®€ä»‹
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../tutorials/index.html">
   æ•™ç¨‹
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../tutorials/basics/index.html">
     PyTorch åŸºç¡€
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
    <label for="toctree-checkbox-2">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../../tutorials/basics/quickstart.html">
       å¿«é€Ÿå…¥é—¨
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../tutorials/basics/autogradqs.html">
       è‡ªåŠ¨å¾®åˆ†
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../tutorials/object-detection/index.html">
     ç›®æ ‡æ£€æµ‹
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
    <label for="toctree-checkbox-3">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3 has-children">
      <a class="reference internal" href="../../tutorials/object-detection/yolo/index.html">
       YOLO ç³»åˆ—
      </a>
      <input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
      <label for="toctree-checkbox-4">
       <i class="fas fa-chevron-down">
       </i>
      </label>
      <ul>
       <li class="toctree-l4">
        <a class="reference internal" href="../../tutorials/object-detection/yolo/intro.html">
         YOLO ç®€ä»‹
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../tutorials/object-detection/yolo/tutorials/index.html">
         YOLO æ•™ç¨‹
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../tutorials/notes/index.html">
     ç¬”è®°
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/>
    <label for="toctree-checkbox-5">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../../tutorials/notes/autograd-mechanics.html">
       è‡ªåŠ¨å¾®åˆ†æœºåˆ¶
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../tutorials/notes/detection.html">
       ç›®æ ‡æ£€æµ‹
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../tutorials/notes/extending.html">
       æ‰©å±• PyTorch
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../tutorials/notes/thop.html">
       THOP: PyTorch OpCounter
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../tutorials/seg-fine-tuning.html">
     å¾®è°ƒåˆ†å‰²
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../quant/index.html">
   é‡åŒ–
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/>
  <label for="toctree-checkbox-6">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../quant/intro.html">
     é‡åŒ–ç®€ä»‹
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../quant/start.html">
     å¿«é€Ÿå…¥é—¨
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../openmmlab/index.html">
   MMDetection
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/>
  <label for="toctree-checkbox-7">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../openmmlab/start.html">
     MMDect å¿«é€Ÿä¸Šæ‰‹
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../index.html">
   Eager é‡åŒ–(æ··ä¹±)
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" type="checkbox"/>
  <label for="toctree-checkbox-8">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../intro.html">
     é‡åŒ–ç®€ä»‹ï¼ˆEagerï¼‰
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../recipes.html">
     é‡åŒ–èœè°±
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../quantized-tensor.html">
     é‡åŒ–å¼ é‡
    </a>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../start/index.html">
     å¿«é€Ÿä¸Šæ‰‹
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" type="checkbox"/>
    <label for="toctree-checkbox-9">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../start/basic.html">
       åŸºç¡€
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../start/ns.html">
       Pytorch æ•°å€¼å¥—ä»¶æ•™ç¨‹
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../study/index.html">
     å­¦ä¹ 
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" type="checkbox"/>
    <label for="toctree-checkbox-10">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../study/intro.html">
       æ¦‚è¿°
      </a>
     </li>
     <li class="toctree-l3 has-children">
      <a class="reference internal" href="../study/transfer-learning/index.html">
       è¿ç§»å­¦ä¹ 
      </a>
      <input class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" type="checkbox"/>
      <label for="toctree-checkbox-11">
       <i class="fas fa-chevron-down">
       </i>
      </label>
      <ul>
       <li class="toctree-l4">
        <a class="reference internal" href="../study/transfer-learning/basic.html">
         è®¡ç®—æœºè§†è§‰åˆ†ç±»
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../study/transfer-learning/quantized.html">
         é‡åŒ–è®¡ç®—æœºè§†è§‰åˆ†ç±»
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../study/transfer-learning/custom.html">
         è‡ªå®šä¹‰
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../study/transfer-learning/cifar.html">
         æµ‹è¯•
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../study/transfer-learning/tvm.html">
         TVM
        </a>
       </li>
      </ul>
     </li>
     <li class="toctree-l3 has-children">
      <a class="reference internal" href="../study/advanced/index.html">
       é«˜çº§æ•™ç¨‹
      </a>
      <input class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" type="checkbox"/>
      <label for="toctree-checkbox-12">
       <i class="fas fa-chevron-down">
       </i>
      </label>
      <ul>
       <li class="toctree-l4">
        <a class="reference internal" href="../study/advanced/custom.html">
         è‡ªå®šä¹‰é‡åŒ–
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../study/advanced/run.html">
         é€šç”¨é‡åŒ–æ¨¡å‹
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../study/advanced/qat.html">
         QAT
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../study/advanced/cifar.html">
         ç‰¹å®šäº cifar10 çš„é‡åŒ–ï¼ˆå¾…æ›´ï¼‰
        </a>
       </li>
      </ul>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../study/qat-resnet18.html">
       QATï¼ˆresnet18ï¼‰
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../study/test.html">
       æµ‹è¯• QAT
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../study/draft.html">
       å›æ”¶ç«™
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="index.html">
     æ•™ç¨‹
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-13" name="toctree-checkbox-13" type="checkbox"/>
    <label for="toctree-checkbox-13">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul class="simple">
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../papers/index.html">
     è®ºæ–‡
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-14" name="toctree-checkbox-14" type="checkbox"/>
    <label for="toctree-checkbox-14">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../papers/gholami2021survey.html">
       A Survey of Quantization Methods for Efficient Neural Network Inference
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../ecosystem/index.html">
   ç”Ÿæ€ç³»ç»Ÿ
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-15" name="toctree-checkbox-15" type="checkbox"/>
  <label for="toctree-checkbox-15">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../ecosystem/intro.html">
     ç®€ä»‹
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../others/index.html">
   å…¶ä»–
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-16" name="toctree-checkbox-16" type="checkbox"/>
  <label for="toctree-checkbox-16">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../others/colab.html">
     Colab è®­ç»ƒ
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../others/en-zh.html">
     ä¸­è‹±äº’è¯‘
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../others/raw.html">
     æœªæ•´ç†çš„èµ„æ–™
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../refs.html">
   å‚è€ƒ
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../glossary/index.html">
   æœ¯è¯­è¡¨
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-17" name="toctree-checkbox-17" type="checkbox"/>
  <label for="toctree-checkbox-17">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../glossary/numpy.html">
     NumPy
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../glossary/pytorch.html">
     PyTorch è¯æ±‡è¡¨
    </a>
   </li>
  </ul>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            <div>
ç‰ˆæƒæ‰€æœ‰Â Â©Â 2021 <a href="https://xinetzone.github.io/">xinetzone</a></div>
<div>ç”± <a href="https://ebp.jupyterbook.org/">EBP</a> æä¾›æŠ€æœ¯æ”¯æŒ</div>
<a href="https://torch-book.readthedocs.io/">ç‰ˆæœ¬åˆ‡æ¢</a>

            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<div class="menu-dropdown menu-dropdown-launch-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Launch interactive content">
      <i class="fas fa-rocket"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://mybinder.org/v2/gh/xinetzone/torch-book/main?urlpath=lab/tree/docs/chaos/tutorial/pqt-qat.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Binder"
>
  

<span class="headerbtn__icon-container">
  
    <img src="../../_static/images/logo_binder.svg">
  </span>
<span class="headerbtn__text-container">Binder</span>
</a>

      </li>
      
      <li>
        <a href="https://colab.research.google.com/github/xinetzone/torch-book/blob/main/docs/chaos/tutorial/pqt-qat.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Colab"
>
  

<span class="headerbtn__icon-container">
  
    <img src="../../_static/images/logo_colab.png">
  </span>
<span class="headerbtn__text-container">Colab</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://github.com/xinetzone/torch-book"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/xinetzone/torch-book/issues/new?title=Issue%20on%20page%20%2Fchaos/tutorial/pqt-qat.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/xinetzone/torch-book/edit/main/docs/chaos/tutorial/pqt-qat.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Edit this page"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="headerbtn__text-container">suggest edit</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../../_sources/chaos/tutorial/pqt-qat.ipynb.txt"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> å¯¼èˆª
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id1">
   èƒŒæ™¯
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id2">
     è¯»è€…
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id3">
     ç¯å¢ƒé…ç½®
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#pqt-qat">
   æ¦‚è¿°ï¼šPQT ä¸ QAT
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#ptq">
     PTQ ç®€ä»‹
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#qat">
     QAT æ¦‚è¿°
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id4">
     PTQ/QAT ç»Ÿä¸€çš„é‡åŒ–æµç¨‹
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id5">
     PTQ/QAT é‡åŒ–ç­–ç•¥
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id6">
   PTQ å’Œ QAT å®æˆ˜
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id7">
     ä¸€äº›å‡†å¤‡å·¥ä½œ
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id8">
     å¾®è°ƒæµ®ç‚¹æ¨¡å‹
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id9">
     é…ç½®å¯é‡åŒ–æ¨¡å‹
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id10">
     PTQ å®æˆ˜
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id11">
     QAT å®æˆ˜
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id12">
     å°ç»“
    </a>
   </li>
  </ul>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>PTQ ä¸ QAT å®è·µ</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> å¯¼èˆª </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id1">
   èƒŒæ™¯
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id2">
     è¯»è€…
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id3">
     ç¯å¢ƒé…ç½®
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#pqt-qat">
   æ¦‚è¿°ï¼šPQT ä¸ QAT
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#ptq">
     PTQ ç®€ä»‹
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#qat">
     QAT æ¦‚è¿°
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id4">
     PTQ/QAT ç»Ÿä¸€çš„é‡åŒ–æµç¨‹
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id5">
     PTQ/QAT é‡åŒ–ç­–ç•¥
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id6">
   PTQ å’Œ QAT å®æˆ˜
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id7">
     ä¸€äº›å‡†å¤‡å·¥ä½œ
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id8">
     å¾®è°ƒæµ®ç‚¹æ¨¡å‹
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id9">
     é…ç½®å¯é‡åŒ–æ¨¡å‹
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id10">
     PTQ å®æˆ˜
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id11">
     QAT å®æˆ˜
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id12">
     å°ç»“
    </a>
   </li>
  </ul>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                 <section class="tex2jax_ignore mathjax_ignore" id="ptq-qat">
<h1>PTQ ä¸ QAT å®è·µ<a class="headerlink" href="#ptq-qat" title="æ°¸ä¹…é“¾æ¥è‡³æ ‡é¢˜">#</a></h1>
<p>æœ¬æ–‡ä¸»è¦ä»‹ç»å¦‚ä½•ä½¿ç”¨ PyTorch å°†æµ®ç‚¹æ¨¡å‹è½¬æ¢ä¸º PTQ æˆ–è€… QAT æ¨¡å‹ã€‚</p>
<section id="id1">
<h2>èƒŒæ™¯<a class="headerlink" href="#id1" title="æ°¸ä¹…é“¾æ¥è‡³æ ‡é¢˜">#</a></h2>
<p><span class="guilabel">ç›®æ ‡</span>ï¼šå¿«é€Ÿå°†æµ®ç‚¹æ¨¡å‹è½¬æ¢ä¸º PTQ æˆ–è€… QAT æ¨¡å‹ã€‚</p>
<section id="id2">
<h3>è¯»è€…<a class="headerlink" href="#id2" title="æ°¸ä¹…é“¾æ¥è‡³æ ‡é¢˜">#</a></h3>
<p>æœ¬æ•™ç¨‹é€‚ç”¨äºä¼šä½¿ç”¨ PyTorch ç¼–å†™ CNN ç­‰æ¨¡å—çš„çš„ç®—æ³•å·¥ç¨‹å¸ˆã€‚</p>
</section>
<section id="id3">
<h3>ç¯å¢ƒé…ç½®<a class="headerlink" href="#id3" title="æ°¸ä¹…é“¾æ¥è‡³æ ‡é¢˜">#</a></h3>
<p>æœ¬æ–‡ä½¿ç”¨ Python 3.10.0 ï¼ˆå…¶ä»–ç‰ˆæœ¬è¯·è‡ªæµ‹ï¼‰ï¼Œæš‚æ—¶ä»… Linux å¹³å°è¢«æµ‹è¯•ã€‚</p>
<p>æŸ¥çœ‹ <code class="docutils literal notranslate"><span class="pre">torch</span></code> å’Œ <code class="docutils literal notranslate"><span class="pre">torchvision</span></code> çš„ç‰ˆæœ¬ï¼š</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torchvision</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;torch: </span><span class="si">{</span><span class="n">torch</span><span class="o">.</span><span class="n">__version__</span><span class="si">}</span><span class="s1"> </span><span class="se">\n</span><span class="s1">&#39;</span>
      <span class="sa">f</span><span class="s1">&#39;torchvision: </span><span class="si">{</span><span class="n">torchvision</span><span class="o">.</span><span class="n">__version__</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>torch: 1.11.0 
torchvision: 0.12.0
</pre></div>
</div>
</div>
</div>
<p>è®¾ç½®ä¸€äº›è­¦å‘Šé…ç½®ï¼š</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># è®¾ç½® warnings</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span>
    <span class="n">action</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span>
    <span class="n">category</span><span class="o">=</span><span class="ne">DeprecationWarning</span><span class="p">,</span>
    <span class="n">module</span><span class="o">=</span><span class="s1">&#39;.*&#39;</span>
<span class="p">)</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span>
    <span class="n">action</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span>
    <span class="n">module</span><span class="o">=</span><span class="s1">&#39;torch.ao.quantization&#39;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="pqt-qat">
<h2>æ¦‚è¿°ï¼šPQT ä¸ QAT<a class="headerlink" href="#pqt-qat" title="æ°¸ä¹…é“¾æ¥è‡³æ ‡é¢˜">#</a></h2>
<p>å‚è€ƒï¼š<a class="reference external" href="https://pytorch.org/docs/master/quantization.html">é‡åŒ–</a></p>
<dl class="simple myst">
<dt><code class="docutils literal notranslate"><span class="pre">è®­ç»ƒåé‡åŒ–</span></code></dt><dd><p>ç®€ç§° PTQï¼ˆPost Training Quantizationï¼‰ï¼šæƒé‡é‡åŒ–ï¼Œæ¿€æ´»é‡åŒ–ï¼Œéœ€è¦å€ŸåŠ©æ•°æ®åœ¨è®­ç»ƒåè¿›è¡Œæ ¡å‡†ã€‚</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">é™æ€é‡åŒ–æ„ŸçŸ¥è®­ç»ƒ</span></code></dt><dd><p>ç®€ç§° QATï¼ˆstatic quantization aware trainingï¼‰ï¼šæƒé‡é‡åŒ–ï¼Œæ¿€æ´»é‡åŒ–ï¼Œåœ¨è®­ç»ƒè¿‡ç¨‹ä¸­çš„é‡åŒ–æ•°å€¼è¿›è¡Œå»ºæ¨¡ã€‚</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">æµ®ç‚¹æ¨¡å‹</span></code></dt><dd><p>æ¨¡å‹çš„ <strong>æƒé‡</strong> å’Œ <strong>æ¿€æ´»</strong> å‡ä¸ºæµ®ç‚¹ç±»å‹ï¼ˆå¦‚ <code class="xref py py-data docutils literal notranslate"><span class="pre">torch.float32</span></code>, <code class="xref py py-data docutils literal notranslate"><span class="pre">torch.float64</span></code>ï¼‰ã€‚</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">é‡åŒ–æ¨¡å‹</span></code></dt><dd><p>æ¨¡å‹çš„ <strong>æƒé‡</strong> å’Œ <strong>æ¿€æ´»</strong> å‡ä¸ºé‡åŒ–ç±»å‹ï¼ˆå¦‚ <code class="xref py py-data docutils literal notranslate"><span class="pre">torch.qint32</span></code>, <code class="xref py py-data docutils literal notranslate"><span class="pre">torch.qint8</span></code>, <code class="xref py py-data docutils literal notranslate"><span class="pre">torch.quint8</span></code>, <code class="xref py py-data docutils literal notranslate"><span class="pre">torch.quint2x4</span></code>, <code class="xref py py-data docutils literal notranslate"><span class="pre">torch.quint4x2</span></code>ï¼‰ã€‚</p>
</dd>
</dl>
<p>ä¸‹é¢ä¸¾ä¾‹è¯´æ˜å¦‚ä½•å°†æµ®ç‚¹æ¨¡å‹è½¬æ¢ä¸ºé‡åŒ–æ¨¡å‹ã€‚</p>
<p>ä¸ºäº†æ–¹ä¾¿è¯´æ˜å®šä¹‰å¦‚ä¸‹æ¨¡å—ï¼š</p>
<p class="rubric">å®šä¹‰ç®€å•çš„æµ®ç‚¹æ¨¡å—</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">nn</span><span class="p">,</span> <span class="n">Tensor</span>


<span class="k">class</span> <span class="nc">M</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relu</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_forward_impl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;æä¾›ä¾¿æ·å‡½æ•°&#39;&#39;&#39;</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
        <span class="n">x</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_forward_impl</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span>
</pre></div>
</div>
</div>
</div>
<p class="rubric">å®šä¹‰å¯é‡åŒ–æ¨¡å—</p>
<p>å°†æµ®ç‚¹æ¨¡å— <code class="docutils literal notranslate"><span class="pre">M</span></code> è½¬æ¢ä¸ºå¯é‡åŒ–æ¨¡å— <code class="docutils literal notranslate"><span class="pre">QM</span></code>ï¼ˆé‡åŒ–æµç¨‹çš„æœ€å…³é”®çš„ä¸€æ­¥ï¼‰ã€‚</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">torch.ao.quantization</span> <span class="kn">import</span> <span class="n">QuantStub</span><span class="p">,</span> <span class="n">DeQuantStub</span>


<span class="k">class</span> <span class="nc">QM</span><span class="p">(</span><span class="n">M</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Args:</span>
<span class="sd">        is_print: ä¸ºäº†æµ‹è¯•éœ€æ±‚ï¼Œæ‰“å°ä¸€äº›ä¿¡æ¯</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_print</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_print</span> <span class="o">=</span> <span class="n">is_print</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quant</span> <span class="o">=</span> <span class="n">QuantStub</span><span class="p">()</span> <span class="c1"># å°†å¼ é‡ä»æµ®ç‚¹è½¬æ¢ä¸ºé‡åŒ–</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dequant</span> <span class="o">=</span> <span class="n">DeQuantStub</span><span class="p">()</span> <span class="c1"># å°†å¼ é‡ä»é‡åŒ–è½¬æ¢ä¸ºæµ®ç‚¹</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
        <span class="c1"># æ‰‹åŠ¨æŒ‡å®šå¼ é‡å°†åœ¨é‡åŒ–æ¨¡å‹ä¸­ä»æµ®ç‚¹æ¨¡å—è½¬æ¢ä¸ºé‡åŒ–æ¨¡å—çš„ä½ç½®</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">quant</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_print</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;é‡åŒ–å‰çš„ç±»å‹ï¼š&#39;</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_forward_impl</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_print</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;é‡åŒ–ä¸­çš„ç±»å‹ï¼š&#39;</span><span class="p">,</span><span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="c1"># åœ¨é‡åŒ–æ¨¡å‹ä¸­æ‰‹åŠ¨æŒ‡å®šå¼ é‡ä»é‡åŒ–åˆ°æµ®ç‚¹çš„è½¬æ¢ä½ç½®</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dequant</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_print</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;é‡åŒ–åçš„ç±»å‹ï¼š&#39;</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span>
</pre></div>
</div>
</div>
</div>
<p>ç®€å•æµ‹è¯•å‰å‘è¿‡ç¨‹çš„æ¿€æ´»æ•°æ®ç±»å‹ï¼š</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">input_fp32</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="c1"># è¾“å…¥çš„æ•°æ®</span>

<span class="n">m</span> <span class="o">=</span> <span class="n">QM</span><span class="p">(</span><span class="n">is_print</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">m</span><span class="p">(</span><span class="n">input_fp32</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>é‡åŒ–å‰çš„ç±»å‹ï¼š torch.float32
é‡åŒ–ä¸­çš„ç±»å‹ï¼š torch.float32
é‡åŒ–åçš„ç±»å‹ï¼š torch.float32
</pre></div>
</div>
</div>
</div>
<p>æŸ¥çœ‹æƒé‡çš„æ•°æ®ç±»å‹ï¼š</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">m</span><span class="o">.</span><span class="n">conv</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">dtype</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>torch.float32
</pre></div>
</div>
</div>
</div>
<p>å¯ä»¥çœ‹å‡ºï¼Œæ­¤æ—¶æ¨¡å— <code class="docutils literal notranslate"><span class="pre">m</span></code> æ˜¯æµ®ç‚¹æ¨¡å—ã€‚</p>
<section id="ptq">
<h3>PTQ ç®€ä»‹<a class="headerlink" href="#ptq" title="æ°¸ä¹…é“¾æ¥è‡³æ ‡é¢˜">#</a></h3>
<p>å½“å†…å­˜å¸¦å®½å’Œè®¡ç®—ç©ºé—´éƒ½å¾ˆé‡è¦æ—¶ï¼Œé€šå¸¸ä¼šä½¿ç”¨è®­ç»ƒåé‡åŒ–ï¼Œè€Œ CNN å°±æ˜¯å…¶å…¸å‹çš„ç”¨ä¾‹ã€‚è®­ç»ƒåé‡åŒ–å¯¹æ¨¡å‹çš„ <strong>æƒé‡</strong> å’Œ <strong>æ¿€æ´»</strong> è¿›è¡Œé‡åŒ–ã€‚å®ƒåœ¨å¯èƒ½çš„æƒ…å†µä¸‹å°† <strong>æ¿€æ´»</strong> èåˆåˆ°å‰é¢çš„å±‚ä¸­ã€‚å®ƒéœ€è¦ç”¨å…·æœ‰ä»£è¡¨æ€§çš„æ•°æ®é›†è¿›è¡Œ <strong>æ ¡å‡†</strong>ï¼Œä»¥ç¡®å®šæ¿€æ´»çš„æœ€ä½³é‡åŒ–å‚æ•°ã€‚</p>
<p class="rubric">ç¤ºæ„å›¾</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># åŸå§‹æ¨¡å‹</span>
<span class="c1"># å…¨éƒ¨çš„å¼ é‡å’Œè®¡ç®—å‡åœ¨æµ®ç‚¹ä¸Šè¿›è¡Œ</span>
<span class="n">previous_layer_fp32</span> <span class="o">--</span> <span class="n">linear_fp32</span> <span class="o">--</span> <span class="n">activation_fp32</span> <span class="o">--</span> <span class="n">next_layer_fp32</span>
                    <span class="o">/</span>
    <span class="n">linear_weight_fp32</span>

<span class="c1"># é™æ€é‡åŒ–æ¨¡å‹</span>
<span class="c1"># weights å’Œ activations åœ¨ int8 ä¸Š</span>
<span class="n">previous_layer_int8</span> <span class="o">--</span> <span class="n">linear_with_activation_int8</span> <span class="o">--</span> <span class="n">next_layer_int8</span>
                    <span class="o">/</span>
  <span class="n">linear_weight_int8</span>
</pre></div>
</div>
<p>ç›´æ¥åˆ›å»ºæµ®ç‚¹æ¨¡å—çš„å®ä¾‹ï¼š</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># åˆ›å»ºæµ®ç‚¹æ¨¡å‹å®ä¾‹</span>
<span class="n">model_fp32</span> <span class="o">=</span> <span class="n">QM</span><span class="p">(</span><span class="n">is_print</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>è¦ä½¿ PTQ ç”Ÿæ•ˆï¼Œå¿…é¡»å°†æ¨¡å‹è®¾ç½®ä¸º <code class="docutils literal notranslate"><span class="pre">eval</span></code> æ¨¡å¼ï¼š</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_fp32</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>QM(
  (conv): Conv2d(1, 1, kernel_size=(1, 1), stride=(1, 1))
  (relu): ReLU()
  (quant): QuantStub()
  (dequant): DeQuantStub()
)
</pre></div>
</div>
</div>
</div>
<p>æŸ¥çœ‹æ­¤æ—¶çš„æ•°æ®ç±»å‹ï¼š</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">input_fp32</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">model_fp32</span><span class="p">(</span><span class="n">input_fp32</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;æ¿€æ´»å’Œæƒé‡çš„æ•°æ®ç±»å‹åˆ†åˆ«ä¸ºï¼š&#39;</span>
      <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">model_fp32</span><span class="o">.</span><span class="n">conv</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>é‡åŒ–å‰çš„ç±»å‹ï¼š torch.float32
é‡åŒ–ä¸­çš„ç±»å‹ï¼š torch.float32
é‡åŒ–åçš„ç±»å‹ï¼š torch.float32
æ¿€æ´»å’Œæƒé‡çš„æ•°æ®ç±»å‹åˆ†åˆ«ä¸ºï¼štorch.float32, torch.float32
</pre></div>
</div>
</div>
</div>
<p class="rubric">å®šä¹‰è§‚æµ‹å™¨</p>
<p>èµ‹å€¼å®ä¾‹å˜é‡ <code class="docutils literal notranslate"><span class="pre">qconfig</span></code>ï¼Œå…¶ä¸­åŒ…å«å…³äºè¦é™„åŠ å“ªç§è§‚æµ‹å™¨çš„ä¿¡æ¯ï¼š</p>
<ul class="simple">
<li><p>ä½¿ç”¨ <a class="reference external" href="https://github.com/pytorch/FBGEMM"><code class="docutils literal notranslate"><span class="pre">'fbgemm'</span></code></a> ç”¨äºå¸¦ AVX2 çš„ x86ï¼ˆæ²¡æœ‰AVX2ï¼Œä¸€äº›è¿ç®—çš„å®ç°æ•ˆç‡å¾ˆä½ï¼‰ï¼›ä½¿ç”¨ <a class="reference external" href="https://github.com/pytorch/pytorch/tree/master/aten/src/ATen/native/quantized/cpu/qnnpack"><code class="docutils literal notranslate"><span class="pre">'qnnpack'</span></code></a> ç”¨äº ARM CPUï¼ˆé€šå¸¸å‡ºç°åœ¨ç§»åŠ¨/åµŒå…¥å¼è®¾å¤‡ä¸­ï¼‰ã€‚</p></li>
<li><p>å…¶ä»–é‡åŒ–é…ç½®ï¼Œå¦‚é€‰æ‹©å¯¹ç§°æˆ–éå¯¹ç§°é‡åŒ–å’Œ <code class="docutils literal notranslate"><span class="pre">MinMax</span></code> æˆ– <code class="docutils literal notranslate"><span class="pre">L2Norm</span></code> æ ¡å‡†æŠ€æœ¯ï¼Œå¯ä»¥åœ¨è¿™é‡ŒæŒ‡å®šã€‚</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_fp32</span><span class="o">.</span><span class="n">qconfig</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ao</span><span class="o">.</span><span class="n">quantization</span><span class="o">.</span><span class="n">get_default_qconfig</span><span class="p">(</span><span class="s1">&#39;fbgemm&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>æŸ¥çœ‹æ­¤æ—¶çš„æ•°æ®ç±»å‹ï¼š</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">input_fp32</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">model_fp32</span><span class="p">(</span><span class="n">input_fp32</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;æ¿€æ´»å’Œæƒé‡çš„æ•°æ®ç±»å‹åˆ†åˆ«ä¸ºï¼š&#39;</span>
      <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">model_fp32</span><span class="o">.</span><span class="n">conv</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>é‡åŒ–å‰çš„ç±»å‹ï¼š torch.float32
é‡åŒ–ä¸­çš„ç±»å‹ï¼š torch.float32
é‡åŒ–åçš„ç±»å‹ï¼š torch.float32
æ¿€æ´»å’Œæƒé‡çš„æ•°æ®ç±»å‹åˆ†åˆ«ä¸ºï¼štorch.float32, torch.float32
</pre></div>
</div>
</div>
</div>
<p class="rubric">èåˆæ¿€æ´»å±‚</p>
<p>åœ¨é€‚ç”¨çš„åœ°æ–¹ï¼Œèåˆ activation åˆ°å‰é¢çš„å±‚ï¼ˆè¿™éœ€è¦æ ¹æ®æ¨¡å‹æ¶æ„æ‰‹åŠ¨å®Œæˆï¼‰ã€‚å¸¸è§çš„èåˆåŒ…æ‹¬ <code class="docutils literal notranslate"><span class="pre">conv</span> <span class="pre">+</span> <span class="pre">relu</span></code> å’Œ <code class="docutils literal notranslate"><span class="pre">conv</span> <span class="pre">+</span> <span class="pre">batchnorm</span> <span class="pre">+</span> <span class="pre">relu</span></code>ã€‚</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_fp32_fused</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ao</span><span class="o">.</span><span class="n">quantization</span><span class="o">.</span><span class="n">fuse_modules</span><span class="p">(</span><span class="n">model_fp32</span><span class="p">,</span>
                                                      <span class="p">[[</span><span class="s1">&#39;conv&#39;</span><span class="p">,</span> <span class="s1">&#39;relu&#39;</span><span class="p">]])</span>
                                                    
<span class="n">model_fp32_fused</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>QM(
  (conv): ConvReLU2d(
    (0): Conv2d(1, 1, kernel_size=(1, 1), stride=(1, 1))
    (1): ReLU()
  )
  (relu): Identity()
  (quant): QuantStub()
  (dequant): DeQuantStub()
)
</pre></div>
</div>
</div>
</div>
<p>å¯ä»¥çœ‹åˆ° <code class="docutils literal notranslate"><span class="pre">model_fp32_fused</span></code> ä¸­ <code class="docutils literal notranslate"><span class="pre">ConvReLU2d</span></code> èåˆ <code class="docutils literal notranslate"><span class="pre">model_fp32</span></code> çš„ä¸¤ä¸ªå±‚ <code class="docutils literal notranslate"><span class="pre">conv</span></code> å’Œ <code class="docutils literal notranslate"><span class="pre">relu</span></code>ã€‚</p>
<p>æŸ¥çœ‹æ­¤æ—¶çš„æ•°æ®ç±»å‹ï¼š</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">input_fp32</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">model_fp32_fused</span><span class="p">(</span><span class="n">input_fp32</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;æ¿€æ´»å’Œæƒé‡çš„æ•°æ®ç±»å‹åˆ†åˆ«ä¸ºï¼š&#39;</span>
      <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">model_fp32</span><span class="o">.</span><span class="n">conv</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>é‡åŒ–å‰çš„ç±»å‹ï¼š torch.float32
é‡åŒ–ä¸­çš„ç±»å‹ï¼š torch.float32
é‡åŒ–åçš„ç±»å‹ï¼š torch.float32
æ¿€æ´»å’Œæƒé‡çš„æ•°æ®ç±»å‹åˆ†åˆ«ä¸ºï¼štorch.float32, torch.float32
</pre></div>
</div>
</div>
</div>
<p class="rubric">å¯ç”¨è§‚æµ‹å™¨</p>
<p>åœ¨èåˆåçš„æ¨¡å—ä¸­å¯ç”¨è§‚æµ‹å™¨ï¼Œç”¨äºåœ¨æ ¡å‡†æœŸé—´è§‚æµ‹æ¿€æ´»ï¼ˆactivationï¼‰å¼ é‡ã€‚</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_fp32_prepared</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">quantization</span><span class="o">.</span><span class="n">prepare</span><span class="p">(</span><span class="n">model_fp32_fused</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p class="rubric">æ ¡å‡†å‡†å¤‡å¥½çš„æ¨¡å‹</p>
<p>æ ¡å‡†å‡†å¤‡å¥½çš„æ¨¡å‹ï¼Œä»¥ç¡®å®šé‡åŒ–å‚æ•°çš„æ¿€æ´»åœ¨ç°å®ä¸–ç•Œçš„è®¾ç½®ï¼Œæ ¡å‡†å…·æœ‰ä»£è¡¨æ€§çš„æ•°æ®é›†ã€‚</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">input_fp32</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">model_fp32_prepared</span><span class="p">(</span><span class="n">input_fp32</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;æ¿€æ´»å’Œæƒé‡çš„æ•°æ®ç±»å‹åˆ†åˆ«ä¸ºï¼š&#39;</span>
      <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">model_fp32</span><span class="o">.</span><span class="n">conv</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>é‡åŒ–å‰çš„ç±»å‹ï¼š torch.float32
é‡åŒ–ä¸­çš„ç±»å‹ï¼š torch.float32
é‡åŒ–åçš„ç±»å‹ï¼š torch.float32
æ¿€æ´»å’Œæƒé‡çš„æ•°æ®ç±»å‹åˆ†åˆ«ä¸ºï¼štorch.float32, torch.float32
</pre></div>
</div>
</div>
</div>
<p class="rubric">æ¨¡å‹è½¬æ¢</p>
<div class="admonition note">
<p class="admonition-title">å¤‡æ³¨</p>
<p>é‡åŒ–æƒé‡ï¼Œè®¡ç®—å’Œå­˜å‚¨æ¯ä¸ªæ¿€æ´»å¼ é‡è¦ä½¿ç”¨çš„å°ºåº¦ï¼ˆscaleï¼‰å’Œåå·®ï¼ˆbiasï¼‰å€¼ï¼Œå¹¶ç”¨é‡åŒ–å®ç°æ›¿æ¢å…³é”®ç®—å­ã€‚</p>
</div>
<p>è½¬æ¢å·²æ ¡å‡†å¥½çš„æ¨¡å‹ä¸ºé‡åŒ–æ¨¡å‹ï¼š</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_int8</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">quantization</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">model_fp32_prepared</span><span class="p">)</span>
<span class="n">model_int8</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>QM(
  (conv): QuantizedConvReLU2d(1, 1, kernel_size=(1, 1), stride=(1, 1), scale=0.010650944896042347, zero_point=0)
  (relu): Identity()
  (quant): Quantize(scale=tensor([0.0351]), zero_point=tensor([74]), dtype=torch.quint8)
  (dequant): DeQuantize()
)
</pre></div>
</div>
</div>
</div>
<p>æŸ¥çœ‹æƒé‡çš„æ•°æ®ç±»å‹ï¼š</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_int8</span><span class="o">.</span><span class="n">conv</span><span class="o">.</span><span class="n">weight</span><span class="p">()</span><span class="o">.</span><span class="n">dtype</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>torch.qint8
</pre></div>
</div>
</div>
</div>
<p>å¯ä»¥çœ‹å‡ºæ­¤æ—¶æƒé‡çš„å…ƒç´ å¤§å°ä¸º 1 å­—èŠ‚ï¼Œè€Œä¸æ˜¯ FP32 çš„ 4 å­—èŠ‚ï¼š</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_int8</span><span class="o">.</span><span class="n">conv</span><span class="o">.</span><span class="n">weight</span><span class="p">()</span><span class="o">.</span><span class="n">element_size</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1
</pre></div>
</div>
</div>
</div>
<p>è¿è¡Œæ¨¡å‹ï¼Œç›¸å…³çš„è®¡ç®—å°†åœ¨ <code class="xref py py-data docutils literal notranslate"><span class="pre">torch.qint8</span></code> ä¸­å‘ç”Ÿã€‚</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res</span> <span class="o">=</span> <span class="n">model_int8</span><span class="p">(</span><span class="n">input_fp32</span><span class="p">)</span>
<span class="n">res</span><span class="o">.</span><span class="n">dtype</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>é‡åŒ–å‰çš„ç±»å‹ï¼š torch.quint8
é‡åŒ–ä¸­çš„ç±»å‹ï¼š torch.quint8
é‡åŒ–åçš„ç±»å‹ï¼š torch.float32
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>torch.float32
</pre></div>
</div>
</div>
</div>
<p>è¦äº†è§£æ›´å¤šå…³äºé‡åŒ–æ„è¯†è®­ç»ƒçš„ä¿¡æ¯ï¼Œè¯·å‚é˜… <a class="reference external" href="https://pytorch.org/tutorials/advanced/static_quantization_tutorial.html">QAT æ•™ç¨‹</a>ã€‚</p>
</section>
<section id="qat">
<h3>QAT æ¦‚è¿°<a class="headerlink" href="#qat" title="æ°¸ä¹…é“¾æ¥è‡³æ ‡é¢˜">#</a></h3>
<p>ä¸å…¶ä»–é‡åŒ–æ–¹æ³•ç›¸æ¯”ï¼ŒQAT åœ¨ <strong>è®­ç»ƒè¿‡ç¨‹ä¸­</strong> æ¨¡æ‹Ÿé‡åŒ–çš„æ•ˆæœï¼Œå¯ä»¥è·å¾—æ›´é«˜çš„ accuracyã€‚åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œæ‰€æœ‰çš„è®¡ç®—éƒ½æ˜¯åœ¨æµ®ç‚¹ä¸Šè¿›è¡Œçš„ï¼Œä½¿ç”¨ fake_quant æ¨¡å—é€šè¿‡å¤¹ç´§å’Œèˆå…¥çš„æ–¹å¼å¯¹é‡åŒ–æ•ˆæœè¿›è¡Œå»ºæ¨¡ï¼Œæ¨¡æ‹Ÿ INT8 çš„æ•ˆæœã€‚æ¨¡å‹è½¬æ¢åï¼Œæƒå€¼å’Œæ¿€æ´»è¢«é‡åŒ–ï¼Œæ¿€æ´»åœ¨å¯èƒ½çš„æƒ…å†µä¸‹è¢«èåˆåˆ°å‰ä¸€å±‚ã€‚å®ƒé€šå¸¸ä¸ CNN ä¸€èµ·ä½¿ç”¨ï¼Œä¸ PTQ ç›¸æ¯”å…·æœ‰æ›´é«˜çš„ accuracyã€‚</p>
<p class="rubric">ç¤ºæ„å›¾</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># åŸå§‹æ¨¡å‹</span>
<span class="c1"># å…¨éƒ¨å¼ é‡å’Œè®¡ç®—å‡åœ¨æµ®ç‚¹ä¸Š</span>
<span class="n">previous_layer_fp32</span> <span class="o">--</span> <span class="n">linear_fp32</span> <span class="o">--</span> <span class="n">activation_fp32</span> <span class="o">--</span> <span class="n">next_layer_fp32</span>
                      <span class="o">/</span>
    <span class="n">linear_weight_fp32</span>

<span class="c1"># åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ä½¿ç”¨ fake_quants å»ºæ¨¡é‡åŒ–æ•°å€¼</span>
<span class="n">previous_layer_fp32</span> <span class="o">--</span> <span class="n">fq</span> <span class="o">--</span> <span class="n">linear_fp32</span> <span class="o">--</span> <span class="n">activation_fp32</span> <span class="o">--</span> <span class="n">fq</span> <span class="o">--</span> <span class="n">next_layer_fp32</span>
                           <span class="o">/</span>
   <span class="n">linear_weight_fp32</span> <span class="o">--</span> <span class="n">fq</span>

<span class="c1"># é‡åŒ–æ¨¡å‹</span>
<span class="c1"># weights å’Œ activations åœ¨ int8 ä¸Š</span>
<span class="n">previous_layer_int8</span> <span class="o">--</span> <span class="n">linear_with_activation_int8</span> <span class="o">--</span> <span class="n">next_layer_int8</span>
                     <span class="o">/</span>
   <span class="n">linear_weight_int8</span>
</pre></div>
</div>
<p>å®šä¹‰æ¯” <code class="docutils literal notranslate"><span class="pre">M</span></code> ç¨å¾®å¤æ‚ä¸€ç‚¹çš„æµ®ç‚¹æ¨¡å—ï¼š</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">M2</span><span class="p">(</span><span class="n">M</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bn</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_forward_impl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;æä¾›ä¾¿æ·å‡½æ•°&#39;&#39;&#39;</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bn</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span>
</pre></div>
</div>
</div>
</div>
<p>åŒæ ·éœ€è¦å®šä¹‰å¯é‡åŒ–æ¨¡å—ï¼š</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">QM2</span><span class="p">(</span><span class="n">M2</span><span class="p">,</span> <span class="n">QM</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>åˆ›å»ºæµ®ç‚¹æ¨¡å‹å®ä¾‹ï¼š</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># åˆ›å»ºæ¨¡å‹å®ä¾‹</span>
<span class="n">model_fp32</span> <span class="o">=</span> <span class="n">QM2</span><span class="p">()</span>
<span class="n">model_fp32</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>QM2(
  (conv): Conv2d(1, 1, kernel_size=(1, 1), stride=(1, 1))
  (relu): ReLU()
  (quant): QuantStub()
  (dequant): DeQuantStub()
  (bn): BatchNorm2d(1, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
)
</pre></div>
</div>
</div>
</div>
<p>æ¨¡å‹å¿…é¡»è®¾ç½®ä¸ºè®­ç»ƒæ¨¡å¼ï¼Œä»¥ä¾¿ QAT å¯ç”¨ï¼š</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_fp32</span><span class="o">.</span><span class="n">train</span><span class="p">();</span>
</pre></div>
</div>
</div>
</div>
<p>æ·»åŠ é‡åŒ–é…ç½®ï¼ˆä¸ PTQ ç›¸åŒç›¸ä¼¼ï¼‰ï¼š</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_fp32</span><span class="o">.</span><span class="n">qconfig</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ao</span><span class="o">.</span><span class="n">quantization</span><span class="o">.</span><span class="n">get_default_qat_qconfig</span><span class="p">(</span><span class="s1">&#39;fbgemm&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p class="rubric">èåˆ QAT æ¨¡å—</p>
<p>QAT çš„æ¨¡å—èåˆä¸ PTQ ç›¸åŒç›¸ä¼¼ï¼š</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">torch.ao.quantization</span> <span class="kn">import</span> <span class="n">fuse_modules_qat</span>

<span class="n">model_fp32_fused</span> <span class="o">=</span> <span class="n">fuse_modules_qat</span><span class="p">(</span><span class="n">model_fp32</span><span class="p">,</span>
                                    <span class="p">[[</span><span class="s1">&#39;conv&#39;</span><span class="p">,</span> <span class="s1">&#39;bn&#39;</span><span class="p">,</span> <span class="s1">&#39;relu&#39;</span><span class="p">]])</span>
</pre></div>
</div>
</div>
</div>
<p class="rubric">å‡†å¤‡ QAT æ¨¡å‹</p>
<p>è¿™å°†åœ¨æ¨¡å‹ä¸­æ’å…¥è§‚æµ‹è€…å’Œä¼ªé‡åŒ–æ¨¡å—ï¼Œå®ƒä»¬å°†åœ¨æ ¡å‡†æœŸé—´è§‚æµ‹æƒé‡å’Œæ¿€æ´»çš„å¼ é‡ã€‚</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_fp32_prepared</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">quantization</span><span class="o">.</span><span class="n">prepare_qat</span><span class="p">(</span><span class="n">model_fp32_fused</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p class="rubric">è®­ç»ƒ QAT æ¨¡å‹</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># ä¸‹æ–‡ä¼šç¼–å†™å®é™…çš„ä¾‹å­ï¼Œæ­¤å¤„æ²¡æœ‰æ˜¾ç¤º</span>
<span class="n">training_loop</span><span class="p">(</span><span class="n">model_fp32_prepared</span><span class="p">)</span>
</pre></div>
</div>
<p>å°†è§‚æµ‹åˆ°çš„æ¨¡å‹è½¬æ¢ä¸ºé‡åŒ–æ¨¡å‹ã€‚éœ€è¦ï¼š</p>
<ul class="simple">
<li><p>é‡åŒ–æƒé‡ï¼Œè®¡ç®—å’Œå­˜å‚¨ç”¨äºæ¯ä¸ªæ¿€æ´»å¼ é‡çš„å°ºåº¦ï¼ˆscaleï¼‰å’Œåå·®ï¼ˆbiasï¼‰å€¼ï¼Œ</p></li>
<li><p>åœ¨é€‚å½“çš„åœ°æ–¹èåˆæ¨¡å—ï¼Œå¹¶ç”¨é‡åŒ–å®ç°æ›¿æ¢å…³é”®ç®—å­ã€‚</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_fp32_prepared</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<span class="n">model_int8</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">quantization</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">model_fp32_prepared</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>è¿è¡Œæ¨¡å‹ï¼Œç›¸å…³çš„è®¡ç®—å°†åœ¨ <code class="xref py py-data docutils literal notranslate"><span class="pre">torch.qint8</span></code> ä¸­å‘ç”Ÿã€‚</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res</span> <span class="o">=</span> <span class="n">model_int8</span><span class="p">(</span><span class="n">input_fp32</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>è¦äº†è§£æ›´å¤šå…³äºé‡åŒ–æ„è¯†è®­ç»ƒçš„ä¿¡æ¯ï¼Œè¯·å‚é˜… <a class="reference external" href="https://pytorch.org/tutorials/advanced/static_quantization_tutorial.html">QAT æ•™ç¨‹</a>ã€‚</p>
</section>
<section id="id4">
<h3>PTQ/QAT ç»Ÿä¸€çš„é‡åŒ–æµç¨‹<a class="headerlink" href="#id4" title="æ°¸ä¹…é“¾æ¥è‡³æ ‡é¢˜">#</a></h3>
<p>PTQ å’Œ QAT çš„é‡åŒ–æµç¨‹ååˆ†ç›¸ä¼¼ï¼Œä¸ºäº†ç»Ÿä¸€æ¥å£ï¼Œå¯ä»¥ä½¿ç”¨ <code class="docutils literal notranslate"><span class="pre">torchvision</span></code> æä¾›çš„å‡½æ•° <a class="reference external" href="https://xinetzone.github.io/pytorch-book/api/pytorch/torchvision/generated/torchvision.models.quantization.utils._fuse_modules.html#torchvision.models.quantization.utils._fuse_modules" title="(åœ¨ Pytorch Book)"><code class="xref py py-func docutils literal notranslate"><span class="pre">_fuse_modules()</span></code></a>ã€‚</p>
<p>ä¸‹é¢åˆ©ç”¨å‡½æ•° <a class="reference external" href="https://xinetzone.github.io/pytorch-book/api/pytorch/torchvision/generated/torchvision.models.quantization.utils._fuse_modules.html#torchvision.models.quantization.utils._fuse_modules" title="(åœ¨ Pytorch Book)"><code class="xref py py-func docutils literal notranslate"><span class="pre">_fuse_modules()</span></code></a> å¯é‡åŒ–æ¨¡å— <code class="docutils literal notranslate"><span class="pre">QM2</span></code>ã€‚</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span>
<span class="kn">from</span> <span class="nn">torch.ao.quantization</span> <span class="kn">import</span> <span class="n">fuse_modules</span><span class="p">,</span> <span class="n">fuse_modules_qat</span>
<span class="kn">from</span> <span class="nn">torch.ao.quantization</span> <span class="kn">import</span> <span class="n">get_default_qconfig</span><span class="p">,</span> <span class="n">get_default_qat_qconfig</span>
<span class="kn">from</span> <span class="nn">torch.ao.quantization</span> <span class="kn">import</span> <span class="n">quantize</span><span class="p">,</span> <span class="n">quantize_qat</span>

<span class="k">def</span> <span class="nf">_fuse_modules</span><span class="p">(</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">modules_to_fuse</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span> <span class="n">is_qat</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
<span class="p">):</span>
    <span class="k">if</span> <span class="n">is_qat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">is_qat</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">training</span>
    <span class="n">method</span> <span class="o">=</span> <span class="n">fuse_modules_qat</span> <span class="k">if</span> <span class="n">is_qat</span> <span class="k">else</span> <span class="n">fuse_modules</span>
    <span class="k">return</span> <span class="n">method</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">modules_to_fuse</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">QM3</span><span class="p">(</span><span class="n">QM2</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;å¯é‡åŒ–æ¨¡å‹</span>
<span class="sd">    Args:</span>
<span class="sd">        is_qat: æ˜¯å¦ä½¿ç”¨ QAT æ¨¡å¼</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_qat</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="s1">&#39;fbgemm&#39;</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_qat</span> <span class="o">=</span> <span class="n">is_qat</span>
        <span class="c1"># å®šä¹‰è§‚æµ‹å™¨</span>
        <span class="k">if</span> <span class="n">is_qat</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">qconfig</span> <span class="o">=</span> <span class="n">get_default_qat_qconfig</span><span class="p">(</span><span class="n">backend</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">qconfig</span> <span class="o">=</span> <span class="n">get_default_qconfig</span><span class="p">(</span><span class="n">backend</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">fuse_model</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;æ¨¡å—èåˆ&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_qat</span><span class="p">:</span>
            <span class="n">modules_to_fuse</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;bn&#39;</span><span class="p">,</span> <span class="s1">&#39;relu&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">modules_to_fuse</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;conv&#39;</span><span class="p">,</span> <span class="s1">&#39;bn&#39;</span><span class="p">,</span> <span class="s1">&#39;relu&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">_fuse_modules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                      <span class="n">modules_to_fuse</span><span class="p">,</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">is_qat</span><span class="p">,</span>
                      <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>æœ‰äº†å¯é‡åŒ–æ¨¡å— <code class="docutils literal notranslate"><span class="pre">QM3</span></code>ï¼Œå¯ä»¥ååˆ†ä¾¿åˆ©çš„åˆ‡æ¢ PTQ/QATäº†ã€‚</p>
<p>æ¯”å¦‚ï¼ŒPTQï¼Œå¯ä»¥è¿™æ ·ï¼š</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">run_fn</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">num_epochs</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_epochs</span><span class="p">):</span>
        <span class="n">input_fp32</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
        <span class="n">model</span><span class="p">(</span><span class="n">input_fp32</span><span class="p">)</span>

<span class="n">num_epochs</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">ptq_model</span> <span class="o">=</span> <span class="n">QM3</span><span class="p">(</span><span class="n">is_qat</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">model_fused</span> <span class="o">=</span> <span class="n">ptq_model</span><span class="o">.</span><span class="n">fuse_model</span><span class="p">()</span>
<span class="n">quanted_model</span> <span class="o">=</span> <span class="n">quantize</span><span class="p">(</span><span class="n">model_fused</span><span class="p">,</span> <span class="n">run_fn</span><span class="p">,</span> <span class="p">[</span><span class="n">num_epochs</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>QAT å¯ä»¥è¿™æ ·ï¼š</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">num_epochs</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">qat_model</span> <span class="o">=</span> <span class="n">QM3</span><span class="p">(</span><span class="n">is_qat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">model_fused</span> <span class="o">=</span> <span class="n">qat_model</span><span class="o">.</span><span class="n">fuse_model</span><span class="p">()</span>
<span class="n">quanted_model</span> <span class="o">=</span> <span class="n">quantize_qat</span><span class="p">(</span><span class="n">model_fused</span><span class="p">,</span> <span class="n">run_fn</span><span class="p">,</span> <span class="p">[</span><span class="n">num_epochs</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id5">
<h3>PTQ/QAT é‡åŒ–ç­–ç•¥<a class="headerlink" href="#id5" title="æ°¸ä¹…é“¾æ¥è‡³æ ‡é¢˜">#</a></h3>
<p>å¯¹äºé€šç”¨é‡åŒ–æŠ€æœ¯ï¼Œéœ€è¦äº†è§£ï¼š</p>
<ol class="arabic simple">
<li><p>å°†ä»»ä½•éœ€è¦è¾“å‡ºå†é‡åŒ–è¯·æ±‚çš„è¿ç®—ï¼ˆå› æ­¤æœ‰é¢å¤–çš„å‚æ•°ï¼‰ä»å‡½æ•°å½¢å¼è½¬æ¢ä¸ºæ¨¡å—å½¢å¼ï¼ˆä¾‹å¦‚ï¼Œä½¿ç”¨ <a class="reference external" href="https://pytorch.org/docs/stable/generated/torch.nn.ReLU.html#torch.nn.ReLU" title="(åœ¨ PyTorch v1.12)"><code class="xref py py-class docutils literal notranslate"><span class="pre">torch.nn.ReLU</span></code></a> è€Œä¸æ˜¯ <a class="reference external" href="https://pytorch.org/docs/stable/generated/torch.nn.functional.relu.html#torch.nn.functional.relu" title="(åœ¨ PyTorch v1.12)"><code class="xref py py-func docutils literal notranslate"><span class="pre">torch.nn.functional.relu()</span></code></a>ï¼‰ã€‚</p></li>
<li><p>é€šè¿‡åœ¨å­æ¨¡å—ä¸ŠæŒ‡å®š <code class="docutils literal notranslate"><span class="pre">.qconfig</span></code> å±æ€§æˆ–æŒ‡å®š <code class="docutils literal notranslate"><span class="pre">qconfig_dict</span></code> æ¥æŒ‡å®šæ¨¡å‹çš„å“ªäº›éƒ¨åˆ†éœ€è¦é‡åŒ–ã€‚ä¾‹å¦‚ï¼Œè®¾ç½® <code class="docutils literal notranslate"><span class="pre">model.conv1.qconfig</span> <span class="pre">=</span> <span class="pre">None</span></code> è¡¨ç¤º <code class="docutils literal notranslate"><span class="pre">model.conv1</span></code> å±‚ä¸é‡åŒ–ï¼Œè®¾ç½® <code class="docutils literal notranslate"><span class="pre">model.linear1.qconfig</span> <span class="pre">=</span> <span class="pre">custom_qconfig</span></code> è¡¨ç¤º <code class="docutils literal notranslate"><span class="pre">model.linear1</span></code> å°†ä½¿ç”¨ <code class="docutils literal notranslate"><span class="pre">custom_qconfig</span></code> è€Œä¸æ˜¯å…¨å±€ <code class="docutils literal notranslate"><span class="pre">qconfig</span></code>ã€‚</p></li>
</ol>
<p>å¯¹äºé‡åŒ–æ¿€æ´»çš„é™æ€é‡åŒ–æŠ€æœ¯ï¼ˆå³å¯¹æ¨¡å‹çš„æƒé‡å’Œæ¿€æ´»å‡è¿›è¡Œé‡åŒ–ï¼ŒåŒ…æ‹¬ PTQ å’Œ QATï¼‰ï¼Œç”¨æˆ·è¿˜éœ€è¦åšä»¥ä¸‹å·¥ä½œï¼š</p>
<ol class="arabic simple">
<li><p>æŒ‡å®šé‡åŒ–å’Œåé‡åŒ–æ¿€æ´»çš„ä½ç½®ã€‚è¿™æ˜¯ä½¿ç”¨ <a class="reference external" href="https://xinetzone.github.io/pytorch-book/api/pytorch/ao/quantization/generated/torch.ao.quantization.stubs.QuantStub.html#torch.ao.quantization.stubs.QuantStub" title="(åœ¨ Pytorch Book)"><code class="xref py py-class docutils literal notranslate"><span class="pre">QuantStub</span></code></a> å’Œ <a class="reference external" href="https://xinetzone.github.io/pytorch-book/api/pytorch/ao/quantization/generated/torch.ao.quantization.stubs.DeQuantStub.html#torch.ao.quantization.stubs.DeQuantStub" title="(åœ¨ Pytorch Book)"><code class="xref py py-class docutils literal notranslate"><span class="pre">DeQuantStub</span></code></a> æ¨¡å—å®Œæˆçš„ã€‚</p></li>
<li><p>ä½¿ç”¨ <a class="reference external" href="https://xinetzone.github.io/pytorch-book/api/pytorch/nn/generated/torch.nn.quantized.FloatFunctional.html#torch.nn.quantized.FloatFunctional" title="(åœ¨ Pytorch Book)"><code class="xref py py-class docutils literal notranslate"><span class="pre">FloatFunctional</span></code></a> å°†éœ€è¦å¯¹é‡åŒ–è¿›è¡Œç‰¹æ®Šå¤„ç†çš„å¼ é‡è¿ç®—å°è£…åˆ°æ¨¡å—ä¸­ã€‚ä¾‹å¦‚åƒ <code class="xref py py-func docutils literal notranslate"><span class="pre">add()</span></code> å’Œ <code class="xref py py-func docutils literal notranslate"><span class="pre">cat()</span></code> è¿™æ ·éœ€è¦ç‰¹æ®Šå¤„ç†æ¥ç¡®å®šè¾“å‡ºé‡åŒ–å‚æ•°çš„è¿ç®—ã€‚</p></li>
<li><p>èåˆæ¨¡å—ï¼šå°†è¿ç®—/æ¨¡å—ç»„åˆæˆå•ä¸ªæ¨¡å—ï¼Œè·å¾—æ›´é«˜çš„ accuracy å’Œæ€§èƒ½ã€‚è¿™æ˜¯ä½¿ç”¨ <a class="reference external" href="https://xinetzone.github.io/pytorch-book/api/pytorch/ao/quantization/generated/torch.ao.quantization.fuse_modules.fuse_modules.html#torch.ao.quantization.fuse_modules.fuse_modules" title="(åœ¨ Pytorch Book)"><code class="xref py py-func docutils literal notranslate"><span class="pre">fuse_modules()</span></code></a> API å®Œæˆçš„ï¼Œè¯¥ API æ¥å—è¦èåˆçš„æ¨¡å—åˆ—è¡¨ã€‚ç›®å‰æ”¯æŒä»¥ä¸‹èåˆï¼š<code class="docutils literal notranslate"><span class="pre">[Conv,</span> <span class="pre">Relu]</span></code>ã€ <code class="docutils literal notranslate"><span class="pre">[Conv,</span> <span class="pre">BatchNorm]</span></code>ã€ <code class="docutils literal notranslate"><span class="pre">[Conv,</span> <span class="pre">BatchNorm,</span> <span class="pre">Relu]</span></code> å’Œ <code class="docutils literal notranslate"><span class="pre">[Linear,</span> <span class="pre">Relu]</span></code>ã€‚</p></li>
</ol>
<p>ç¤ºä¾‹ï¼š</p>
<figure class="align-center" id="id13">
<img alt="../../_images/resnet.png" class="w3-border" src="../../_images/resnet.png" />
<figcaption>
<p><span class="caption-text">å€’ç½®æ®‹å·®å—çš„è½¬æ¢å‰åå¯¹æ¯”</span><a class="headerlink" href="#id13" title="æ°¸ä¹…é“¾æ¥è‡³å›¾ç‰‡">#</a></p>
</figcaption>
</figure>
</section>
</section>
<section id="id6">
<h2>PTQ å’Œ QAT å®æˆ˜<a class="headerlink" href="#id6" title="æ°¸ä¹…é“¾æ¥è‡³æ ‡é¢˜">#</a></h2>
<p class="rubric">æ¨¡å‹å¯¹æ¯”</p>
<table class="colwidths-auto table">
<thead>
<tr class="row-odd"><th class="text-left head"><p>ç±»å‹</p></th>
<th class="text-left head"><p>å¤§å°ï¼ˆMBï¼‰</p></th>
<th class="text-left head"><p>accuracyï¼ˆ<span class="math notranslate nohighlight">\(\%\)</span>ï¼‰</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-left"><p>æµ®ç‚¹</p></td>
<td class="text-left"><p>9.188</p></td>
<td class="text-left"><p>94.91</p></td>
</tr>
<tr class="row-odd"><td class="text-left"><p>æµ®ç‚¹èåˆ</p></td>
<td class="text-left"><p>8.924</p></td>
<td class="text-left"><p>94.91</p></td>
</tr>
<tr class="row-even"><td class="text-left"><p>QAT</p></td>
<td class="text-left"><p>2.657</p></td>
<td class="text-left"><p>94.41</p></td>
</tr>
</tbody>
</table>
<p class="rubric">ä¸åŒ QConfig çš„é™æ€ PTQ æ¨¡å‹</p>
<table class="colwidths-auto table">
<thead>
<tr class="row-odd"><th class="text-left head"><p>accuracyï¼ˆ<span class="math notranslate nohighlight">\(\%\)</span>ï¼‰</p></th>
<th class="text-left head"><p>æ¿€æ´»</p></th>
<th class="text-left head"><p>æƒé‡</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-left"><p>51.11</p></td>
<td class="text-left"><p><code class="xref py py-data docutils literal notranslate"><span class="pre">MinMaxObserver</span></code>.<code class="docutils literal notranslate"><span class="pre">with_args(quant_min=0,</span> <span class="pre">quant_max=127)</span></code></p></td>
<td class="text-left"><p><code class="xref py py-data docutils literal notranslate"><span class="pre">MinMaxObserver</span></code>.<code class="docutils literal notranslate"><span class="pre">with_args(dtype=torch.qint8,</span> <span class="pre">qscheme=torch.per_tensor_symmetric)</span></code></p></td>
</tr>
<tr class="row-odd"><td class="text-left"><p>80.42</p></td>
<td class="text-left"><p><code class="xref py py-data docutils literal notranslate"><span class="pre">HistogramObserver</span></code>.<code class="docutils literal notranslate"><span class="pre">with_args(quant_min=0,</span> <span class="pre">quant_max=127)</span></code></p></td>
<td class="text-left"><p><code class="xref py py-data docutils literal notranslate"><span class="pre">PerChannelMinMaxObserver</span></code>.<code class="docutils literal notranslate"><span class="pre">with_args(dtype=torch.qint8,</span> <span class="pre">qscheme=torch.per_channel_symmetric)</span></code></p></td>
</tr>
</tbody>
</table>
<p>ä¸ºäº†æä¾›ä¸€è‡´çš„é‡åŒ–å·¥å…·æ¥å£ï¼Œæˆ‘ä»¬ä½¿ç”¨ Python åŒ… <code class="docutils literal notranslate"><span class="pre">torchq</span></code>ã€‚</p>
<p>æœ¬åœ°è½½å…¥ä¸´æ—¶ <code class="docutils literal notranslate"><span class="pre">torchq</span></code> åŒ…ï¼š</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mod</span> <span class="kn">import</span> <span class="n">torchq</span>
</pre></div>
</div>
</div>
</div>
<div class="admonition tip">
<p class="admonition-title">å°æŠ€å·§</p>
<p>æœ¬æ–‡ä½¿ç”¨ <code class="docutils literal notranslate"><span class="pre">torchq</span></code> çš„ <code class="docutils literal notranslate"><span class="pre">'0.0.1-alpha'</span></code> ç‰ˆæœ¬ã€‚</p>
</div>
<p>æ›´æ–¹ä¾¿çš„æ˜¯ï¼šä½¿ç”¨ <code class="docutils literal notranslate"><span class="pre">pip</span></code> å®‰è£…ï¼š</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>pip install <span class="nv">torchq</span><span class="o">==</span><span class="m">0</span>.0.1-alpha
</pre></div>
</div>
<p>æ¥ç€ï¼Œä¾¿å¯ä»¥ç›´æ¥å¯¼å…¥ï¼š</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">torchq</span>
</pre></div>
</div>
<div class="admonition tip">
<p class="admonition-title">å°æŠ€å·§</p>
<p>æœ¬æ–‡ä½¿ç”¨ <code class="docutils literal notranslate"><span class="pre">torchq</span></code> çš„ <code class="docutils literal notranslate"><span class="pre">'0.0.1-alpha'</span></code> ç‰ˆæœ¬ã€‚</p>
</div>
<p>å¯ä»¥çœ‹å‡º PTQ å’Œ QAT éœ€è¦ç”¨æˆ·è‡ªå®šä¹‰çš„å†…å®¹ä¸»è¦é›†ä¸­åœ¨ï¼š <strong>æ¨¡å—èåˆ</strong> å’Œ <strong>ç®—å­æ›¿æ¢</strong>ã€‚</p>
<p><a class="reference external" href="https://xinetzone.github.io/pytorch-book/api/pytorch/torchvision/generated/torchvision.models.quantization.utils._fuse_modules.html#torchvision.models.quantization.utils._fuse_modules" title="(åœ¨ Pytorch Book)"><code class="xref py py-func docutils literal notranslate"><span class="pre">_fuse_modules()</span></code></a> æä¾›äº† <a class="reference external" href="https://xinetzone.github.io/pytorch-book/api/pytorch/ao/quantization/generated/torch.ao.quantization.fuse_modules.fuse_modules.html#torch.ao.quantization.fuse_modules.fuse_modules" title="(åœ¨ Pytorch Book)"><code class="xref py py-func docutils literal notranslate"><span class="pre">fuse_modules()</span></code></a> å’Œ <a class="reference external" href="https://xinetzone.github.io/pytorch-book/api/pytorch/ao/quantization/generated/torch.ao.quantization.fuse_modules.fuse_modules_qat.html#torch.ao.quantization.fuse_modules.fuse_modules_qat" title="(åœ¨ Pytorch Book)"><code class="xref py py-func docutils literal notranslate"><span class="pre">fuse_modules_qat()</span></code></a> çš„ç»Ÿä¸€æ¥å£ã€‚ä¸‹é¢ä»¥ MobileNetV2 ä¸ºä¾‹ï¼Œç®€è¿°å¦‚ä½•ä½¿ç”¨ <a class="reference external" href="https://xinetzone.github.io/pytorch-book/api/pytorch/torchvision/generated/torchvision.models.quantization.utils._fuse_modules.html#torchvision.models.quantization.utils._fuse_modules" title="(åœ¨ Pytorch Book)"><code class="xref py py-func docutils literal notranslate"><span class="pre">_fuse_modules()</span></code></a> å‡½æ•°å’Œ <a class="reference external" href="https://xinetzone.github.io/pytorch-book/api/pytorch/nn/generated/torch.nn.quantized.FloatFunctional.html#torch.nn.quantized.FloatFunctional" title="(åœ¨ Pytorch Book)"><code class="xref py py-class docutils literal notranslate"><span class="pre">FloatFunctional</span></code></a> ç±»å®šåˆ¶å¯é‡åŒ–çš„æ¨¡å—ã€‚</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39;å‚è€ƒ torchvision/models/quantization/mobilenetv2.py</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span>
<span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">Tensor</span>
<span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">nn</span>

<span class="kn">from</span> <span class="nn">torchvision._internally_replaced_utils</span> <span class="kn">import</span> <span class="n">load_state_dict_from_url</span>
<span class="kn">from</span> <span class="nn">torchvision.ops.misc</span> <span class="kn">import</span> <span class="n">ConvNormActivation</span>
<span class="kn">from</span> <span class="nn">torchvision.models.quantization.utils</span> <span class="kn">import</span> <span class="n">_fuse_modules</span><span class="p">,</span> <span class="n">_replace_relu</span><span class="p">,</span> <span class="n">quantize_model</span>
<span class="kn">from</span> <span class="nn">torch.ao.quantization</span> <span class="kn">import</span> <span class="n">QuantStub</span><span class="p">,</span> <span class="n">DeQuantStub</span>
<span class="kn">from</span> <span class="nn">torchvision.models.mobilenetv2</span> <span class="kn">import</span> <span class="n">InvertedResidual</span><span class="p">,</span> <span class="n">MobileNetV2</span><span class="p">,</span> <span class="n">model_urls</span>

<span class="n">quant_model_urls</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;mobilenet_v2_qnnpack&quot;</span><span class="p">:</span> <span class="s2">&quot;https://download.pytorch.org/models/quantized/mobilenet_v2_qnnpack_37f702c5.pth&quot;</span>
<span class="p">}</span>


<span class="k">class</span> <span class="nc">QuantizableInvertedResidual</span><span class="p">(</span><span class="n">InvertedResidual</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">skip_add</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">quantized</span><span class="o">.</span><span class="n">FloatFunctional</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_res_connect</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">skip_add</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">fuse_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_qat</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conv</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conv</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="ow">is</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">:</span>
                <span class="n">_fuse_modules</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conv</span><span class="p">,</span>
                              <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">),</span>
                               <span class="nb">str</span><span class="p">(</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)],</span>
                              <span class="n">is_qat</span><span class="p">,</span>
                              <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">QuantizableMobileNetV2</span><span class="p">(</span><span class="n">MobileNetV2</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        MobileNet V2 main class</span>

<span class="sd">        Args:</span>
<span class="sd">           ç»§æ‰¿è‡ªæµ®ç‚¹ MobileNetV2 çš„å‚æ•°</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quant</span> <span class="o">=</span> <span class="n">QuantStub</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dequant</span> <span class="o">=</span> <span class="n">DeQuantStub</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">quant</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_forward_impl</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dequant</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span>

    <span class="k">def</span> <span class="nf">fuse_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_qat</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modules</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="ow">is</span> <span class="n">ConvNormActivation</span><span class="p">:</span>
                <span class="n">_fuse_modules</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;2&quot;</span><span class="p">],</span> <span class="n">is_qat</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="ow">is</span> <span class="n">QuantizableInvertedResidual</span><span class="p">:</span>
                <span class="n">m</span><span class="o">.</span><span class="n">fuse_model</span><span class="p">(</span><span class="n">is_qat</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">mobilenet_v2</span><span class="p">(</span>
    <span class="n">pretrained</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">progress</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">quantize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">QuantizableMobileNetV2</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ä» `MobileNetV2ï¼šåå‘æ®‹å·®å’Œçº¿æ€§ç“¶é¢ˆ &lt;https://arxiv.org/abs/1801.04381&gt;`_ æ„å»º MobileNetV2 æ¶æ„ã€‚</span>

<span class="sd">    æ³¨æ„ï¼Œquantize = True è¿”å›å…·æœ‰ 8 bit æƒå€¼çš„é‡åŒ–æ¨¡å‹ã€‚é‡åŒ–æ¨¡å‹åªæ”¯æŒæ¨ç†å¹¶åœ¨ CPU ä¸Šè¿è¡Œã€‚</span>
<span class="sd">    ç›®å‰è¿˜ä¸æ”¯æŒ GPU æ¨ç†</span>

<span class="sd">    Args:</span>
<span class="sd">        pretrained (bool): å¦‚æœä¸º Trueï¼Œè¿”å›åœ¨ ImageNet ä¸Šè®­ç»ƒè¿‡çš„æ¨¡å‹ã€‚</span>
<span class="sd">        progress (bool): å¦‚æœä¸º Trueï¼Œåˆ™æ˜¾ç¤ºä¸‹è½½åˆ°æ ‡å‡†é”™è¯¯çš„è¿›åº¦æ¡</span>
<span class="sd">        quantize(bool): å¦‚æœä¸º Trueï¼Œåˆ™è¿”å›é‡åŒ–æ¨¡å‹ï¼Œå¦åˆ™è¿”å›æµ®ç‚¹æ¨¡å‹</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">QuantizableMobileNetV2</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="n">QuantizableInvertedResidual</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">_replace_relu</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">quantize</span><span class="p">:</span>
        <span class="c1"># TODO use pretrained as a string to specify the backend</span>
        <span class="n">backend</span> <span class="o">=</span> <span class="s2">&quot;qnnpack&quot;</span>
        <span class="n">quantize_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">backend</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">pretrained</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">pretrained</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">quantize</span><span class="p">:</span>
            <span class="n">model_url</span> <span class="o">=</span> <span class="n">quant_model_urls</span><span class="p">[</span><span class="s2">&quot;mobilenet_v2_&quot;</span> <span class="o">+</span> <span class="n">backend</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">model_url</span> <span class="o">=</span> <span class="n">model_urls</span><span class="p">[</span><span class="s2">&quot;mobilenet_v2&quot;</span><span class="p">]</span>

        <span class="n">state_dict</span> <span class="o">=</span> <span class="n">load_state_dict_from_url</span><span class="p">(</span><span class="n">model_url</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="n">progress</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">state_dict</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">model</span>
</pre></div>
</div>
</div>
</div>
<section id="id7">
<h3>ä¸€äº›å‡†å¤‡å·¥ä½œ<a class="headerlink" href="#id7" title="æ°¸ä¹…é“¾æ¥è‡³æ ‡é¢˜">#</a></h3>
<p>ä¸‹é¢ä»¥ Cifar10 ä¸ºäº†æ¥è¯´æ˜ PTQ/QAT çš„é‡åŒ–æµç¨‹ã€‚</p>
<p>å®šä¹‰å‡ ä¸ª<a class="reference external" href="https://github.com/pytorch/examples/blob/master/imagenet/main.py">è¾…åŠ©å‡½æ•°</a>æ¥å¸®åŠ©è¯„ä¼°æ¨¡å‹ã€‚</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">torchq.helper</span> <span class="kn">import</span> <span class="n">evaluate</span><span class="p">,</span> <span class="n">print_size_of_model</span><span class="p">,</span> <span class="n">load_model</span>
</pre></div>
</div>
</div>
</div>
<p>è®¾ç½®è¶…å‚æ•°ï¼š</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">saved_model_dir</span> <span class="o">=</span> <span class="s1">&#39;models/&#39;</span>
<span class="n">float_model_file</span> <span class="o">=</span> <span class="s1">&#39;mobilenet_pretrained_float.pth&#39;</span>
<span class="n">scripted_float_model_file</span> <span class="o">=</span> <span class="s1">&#39;mobilenet_float_scripted.pth&#39;</span>
<span class="n">scripted_ptq_model_file</span> <span class="o">=</span> <span class="s1">&#39;mobilenet_ptq_scripted.pth&#39;</span>
<span class="n">scripted_quantized_model_file</span> <span class="o">=</span> <span class="s1">&#39;mobilenet_quantization_scripted_quantized.pth&#39;</span>
<span class="n">scripted_qat_model_file</span> <span class="o">=</span> <span class="s1">&#39;mobilenet_qat_scripted_quantized.pth&#39;</span>

<span class="n">learning_rate</span> <span class="o">=</span> <span class="mf">5e-5</span>
<span class="n">num_epochs</span> <span class="o">=</span> <span class="mi">30</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">16</span>
<span class="n">num_classes</span> <span class="o">=</span> <span class="mi">10</span>

<span class="c1"># è®¾ç½®è¯„ä¼°ç­–ç•¥</span>
<span class="n">criterion</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>å®šä¹‰æ•°æ®é›†å’Œæ•°æ®åŠ è½½å™¨ï¼š</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">torchq.xinet</span> <span class="kn">import</span> <span class="n">CV</span>

<span class="c1"># ä¸ºäº† cifar10 åŒ¹é… ImageNetï¼Œéœ€è¦å°†å…¶ resize åˆ° 224</span>
<span class="n">train_iter</span><span class="p">,</span> <span class="n">test_iter</span> <span class="o">=</span> <span class="n">CV</span><span class="o">.</span><span class="n">load_data_cifar10</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
                                             <span class="n">resize</span><span class="o">=</span><span class="mi">224</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Files already downloaded and verified
Files already downloaded and verified
</pre></div>
</div>
</div>
</div>
<p>æŸ¥çœ‹æ•°æ®é›†çš„ batch æ¬¡æ•°ï¼š</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;è®­ç»ƒã€æµ‹è¯•æ‰¹æ¬¡åˆ†åˆ«ä¸ºï¼š&#39;</span><span class="p">,</span>
      <span class="nb">len</span><span class="p">(</span><span class="n">train_iter</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_iter</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>è®­ç»ƒã€æµ‹è¯•æ‰¹æ¬¡åˆ†åˆ«ä¸ºï¼š 3125 625
</pre></div>
</div>
</div>
</div>
<p>è·å–è®­ç»ƒå’Œæµ‹è¯•æ•°æ®é›†çš„å¤§å°ï¼š</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">num_train</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ys</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">ys</span> <span class="ow">in</span> <span class="n">train_iter</span><span class="p">)</span>
<span class="n">num_eval</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ys</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">ys</span> <span class="ow">in</span> <span class="n">test_iter</span><span class="p">)</span>
<span class="n">num_train</span><span class="p">,</span> <span class="n">num_eval</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(50000, 10000)
</pre></div>
</div>
</div>
</div>
</section>
<section id="id8">
<h3>å¾®è°ƒæµ®ç‚¹æ¨¡å‹<a class="headerlink" href="#id8" title="æ°¸ä¹…é“¾æ¥è‡³æ ‡é¢˜">#</a></h3>
<p>é…ç½®æµ®ç‚¹æ¨¡å‹ï¼š</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#from torchvision.models.quantization import mobilenet_v2</span>

<span class="c1"># å®šä¹‰æ¨¡å‹</span>
<span class="k">def</span> <span class="nf">create_model</span><span class="p">(</span><span class="n">quantize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">num_classes</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                 <span class="n">pretrained</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">float_model</span> <span class="o">=</span> <span class="n">mobilenet_v2</span><span class="p">(</span><span class="n">pretrained</span><span class="o">=</span><span class="n">pretrained</span><span class="p">,</span>
                               <span class="n">quantize</span><span class="o">=</span><span class="n">quantize</span><span class="p">)</span>
    <span class="c1"># åŒ¹é… ``num_classes``</span>
    <span class="n">float_model</span><span class="o">.</span><span class="n">classifier</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">float_model</span><span class="o">.</span><span class="n">last_channel</span><span class="p">,</span>
                                          <span class="n">num_classes</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">float_model</span>
</pre></div>
</div>
</div>
</div>
<p>å®šä¹‰æ¨¡å‹ï¼š</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">float_model</span> <span class="o">=</span> <span class="n">create_model</span><span class="p">(</span><span class="n">pretrained</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                           <span class="n">quantize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                           <span class="n">num_classes</span><span class="o">=</span><span class="n">num_classes</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>å®šä¹‰å¾®è°ƒçš„å‡½æ•° <code class="xref py py-class docutils literal notranslate"><span class="pre">torchq.xinet.CV</span></code>.<code class="xref py py-func docutils literal notranslate"><span class="pre">train_fine_tuning()</span></code> ç”¨äºæ¨¡å‹ã€‚</p>
<p>å¾®è°ƒæµ®ç‚¹æ¨¡å‹ï¼š</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">CV</span><span class="o">.</span><span class="n">train_fine_tuning</span><span class="p">(</span><span class="n">float_model</span><span class="p">,</span> <span class="n">train_iter</span><span class="p">,</span> <span class="n">test_iter</span><span class="p">,</span>
                     <span class="n">learning_rate</span><span class="o">=</span><span class="n">learning_rate</span><span class="p">,</span>
                     <span class="n">num_epochs</span><span class="o">=</span><span class="n">num_epochs</span><span class="p">,</span>
                     <span class="n">device</span><span class="o">=</span><span class="s1">&#39;cuda:2&#39;</span><span class="p">,</span>
                     <span class="n">param_group</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>loss 0.012, train acc 0.996, test acc 0.949
276.9 examples/sec on cuda:2
</pre></div>
</div>
<img alt="../../_images/dd7d8af477f080b750fef09b95e520b1d000528a96cb0608c2c2bb0db17b4972.svg" src="../../_images/dd7d8af477f080b750fef09b95e520b1d000528a96cb0608c2c2bb0db17b4972.svg" /></div>
</div>
<p>ä¿å­˜æ¨¡å‹ï¼š</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">float_model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="n">saved_model_dir</span> <span class="o">+</span> <span class="n">float_model_file</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id9">
<h3>é…ç½®å¯é‡åŒ–æ¨¡å‹<a class="headerlink" href="#id9" title="æ°¸ä¹…é“¾æ¥è‡³æ ‡é¢˜">#</a></h3>
<p>åŠ è½½æµ®ç‚¹æ¨¡å‹ï¼š</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">float_model</span> <span class="o">=</span> <span class="n">create_model</span><span class="p">(</span><span class="n">quantize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                           <span class="n">num_classes</span><span class="o">=</span><span class="n">num_classes</span><span class="p">)</span>
<span class="n">float_model</span> <span class="o">=</span> <span class="n">load_model</span><span class="p">(</span><span class="n">float_model</span><span class="p">,</span> <span class="n">saved_model_dir</span> <span class="o">+</span> <span class="n">float_model_file</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>æŸ¥çœ‹æµ®ç‚¹æ¨¡å‹çš„ä¿¡æ¯ï¼š</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">print_info</span><span class="p">(</span><span class="n">model</span><span class="p">,</span>
               <span class="n">model_type</span><span class="o">=</span><span class="s1">&#39;æµ®ç‚¹æ¨¡å‹&#39;</span><span class="p">,</span>
               <span class="n">test_iter</span><span class="o">=</span><span class="n">test_iter</span><span class="p">,</span>
               <span class="n">criterion</span><span class="o">=</span><span class="n">criterion</span><span class="p">,</span> <span class="n">num_eval</span><span class="o">=</span><span class="n">num_eval</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;æ‰“å°ä¿¡æ¯&#39;&#39;&#39;</span>
    <span class="n">print_size_of_model</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="n">top1</span><span class="p">,</span> <span class="n">top5</span> <span class="o">=</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">criterion</span><span class="p">,</span> <span class="n">test_iter</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="si">{</span><span class="n">model_type</span><span class="si">}</span><span class="s1">ï¼š</span><span class="se">\n\t</span><span class="s1">&#39;</span>
          <span class="sa">f</span><span class="s1">&#39;åœ¨ </span><span class="si">{</span><span class="n">num_eval</span><span class="si">}</span><span class="s1"> å¼ å›¾ç‰‡ä¸Šè¯„ä¼° accuracy ä¸º: </span><span class="si">{</span><span class="n">top1</span><span class="o">.</span><span class="n">avg</span><span class="si">:</span><span class="s1">2.5f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">print_info</span><span class="p">(</span><span class="n">float_model</span><span class="p">,</span> <span class="n">model_type</span><span class="o">=</span><span class="s1">&#39;æµ®ç‚¹æ¨¡å‹&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>æ¨¡å‹å¤§å°ï¼š9.187789 MB

æµ®ç‚¹æ¨¡å‹ï¼š
	åœ¨ 10000 å¼ å›¾ç‰‡ä¸Šè¯„ä¼° accuracy ä¸º: 94.91000
</pre></div>
</div>
</div>
</div>
<p>å¯ä»¥å…ˆæŸ¥çœ‹èåˆå‰çš„ inverted residual å—ï¼š</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">float_model</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">conv</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Sequential(
  (0): ConvNormActivation(
    (0): Conv2d(32, 32, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), groups=32, bias=False)
    (1): BatchNorm2d(32, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
    (2): ReLU()
  )
  (1): Conv2d(32, 16, kernel_size=(1, 1), stride=(1, 1), bias=False)
  (2): BatchNorm2d(16, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
)
</pre></div>
</div>
</div>
</div>
<p>èåˆæ¨¡å—ï¼š</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">float_model</span><span class="o">.</span><span class="n">fuse_model</span><span class="p">(</span><span class="n">is_qat</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>æŸ¥çœ‹èåˆåçš„ inverted residual å—ï¼š</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">float_model</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">conv</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Sequential(
  (0): ConvNormActivation(
    (0): ConvReLU2d(
      (0): Conv2d(32, 32, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), groups=32)
      (1): ReLU()
    )
    (1): Identity()
    (2): Identity()
  )
  (1): Conv2d(32, 16, kernel_size=(1, 1), stride=(1, 1))
  (2): Identity()
)
</pre></div>
</div>
</div>
</div>
<p>ä¸ºäº†å¾—åˆ°â€œåŸºçº¿â€ç²¾åº¦ï¼Œçœ‹çœ‹èåˆæ¨¡å—çš„éé‡åŒ–æ¨¡å‹çš„ç²¾åº¦ï¼š</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_type</span> <span class="o">=</span> <span class="s1">&#39;èåˆåçš„æµ®ç‚¹æ¨¡å‹&#39;</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;baseline æ¨¡å‹å¤§å°&quot;</span><span class="p">)</span>
<span class="n">print_size_of_model</span><span class="p">(</span><span class="n">float_model</span><span class="p">)</span>

<span class="n">top1</span><span class="p">,</span> <span class="n">top5</span> <span class="o">=</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">float_model</span><span class="p">,</span> <span class="n">criterion</span><span class="p">,</span> <span class="n">test_iter</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>baseline æ¨¡å‹å¤§å°
æ¨¡å‹å¤§å°ï¼š8.923757 MB
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">jit</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="si">{</span><span class="n">model_type</span><span class="si">}</span><span class="s1">ï¼š</span><span class="se">\n\t</span><span class="s1">åœ¨ </span><span class="si">{</span><span class="n">num_eval</span><span class="si">}</span><span class="s1"> å¼ å›¾ç‰‡ä¸Šè¯„ä¼° accuracy ä¸º: </span><span class="si">{</span><span class="n">top1</span><span class="o">.</span><span class="n">avg</span><span class="si">:</span><span class="s1">2.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="c1"># ä¿å­˜</span>
<span class="n">jit</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">jit</span><span class="o">.</span><span class="n">script</span><span class="p">(</span><span class="n">float_model</span><span class="p">),</span> <span class="n">saved_model_dir</span> <span class="o">+</span> <span class="n">scripted_float_model_file</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>èåˆåçš„æµ®ç‚¹æ¨¡å‹ï¼š
	åœ¨ 10000 å¼ å›¾ç‰‡ä¸Šè¯„ä¼° accuracy ä¸º: 94.91
</pre></div>
</div>
</div>
</div>
<p>è¿™å°†æ˜¯æˆ‘ä»¬è¿›è¡Œæ¯”è¾ƒçš„åŸºå‡†ã€‚æ¥ä¸‹æ¥ï¼Œå°è¯•ä¸åŒçš„é‡åŒ–æ–¹æ³•ã€‚</p>
</section>
<section id="id10">
<h3>PTQ å®æˆ˜<a class="headerlink" href="#id10" title="æ°¸ä¹…é“¾æ¥è‡³æ ‡é¢˜">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># åŠ è½½æ¨¡å‹</span>
<span class="n">myModel</span> <span class="o">=</span> <span class="n">create_model</span><span class="p">(</span><span class="n">pretrained</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                       <span class="n">quantize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                       <span class="n">num_classes</span><span class="o">=</span><span class="n">num_classes</span><span class="p">)</span>
<span class="n">float_model</span> <span class="o">=</span> <span class="n">load_model</span><span class="p">(</span><span class="n">myModel</span><span class="p">,</span>
                         <span class="n">saved_model_dir</span> <span class="o">+</span> <span class="n">float_model_file</span><span class="p">)</span>
<span class="n">myModel</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>

<span class="c1"># èåˆ</span>
<span class="n">myModel</span><span class="o">.</span><span class="n">fuse_model</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>æŒ‡å®šé‡åŒ–é…ç½®ï¼ˆä»ç®€å•çš„æœ€å°/æœ€å¤§èŒƒå›´ä¼°è®¡å’ŒåŠ æƒçš„é€å¼ é‡é‡åŒ–å¼€å§‹ï¼‰ï¼š</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">torch.ao.quantization.qconfig</span> <span class="kn">import</span> <span class="n">default_qconfig</span>

<span class="n">myModel</span><span class="o">.</span><span class="n">qconfig</span> <span class="o">=</span> <span class="n">default_qconfig</span>
<span class="n">myModel</span><span class="o">.</span><span class="n">qconfig</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>QConfig(activation=functools.partial(&lt;class &#39;torch.ao.quantization.observer.MinMaxObserver&#39;&gt;, quant_min=0, quant_max=127){}, weight=functools.partial(&lt;class &#39;torch.ao.quantization.observer.MinMaxObserver&#39;&gt;, dtype=torch.qint8, qscheme=torch.per_tensor_symmetric){})
</pre></div>
</div>
</div>
</div>
<p>å¼€å§‹æ ¡å‡†å‡†å¤‡ï¼š</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">torch.ao.quantization.quantize</span> <span class="kn">import</span> <span class="n">prepare</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;PTQ å‡†å¤‡ï¼šæ’å…¥è§‚æµ‹è€…&#39;</span><span class="p">)</span>
<span class="n">prepare</span><span class="p">(</span><span class="n">myModel</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> æŸ¥çœ‹è§‚æµ‹è€…æ’å…¥åçš„ inverted residual </span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">,</span>
      <span class="n">myModel</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">conv</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>PTQ å‡†å¤‡ï¼šæ’å…¥è§‚æµ‹è€…

 æŸ¥çœ‹è§‚æµ‹è€…æ’å…¥åçš„ inverted residual 

 Sequential(
  (0): ConvNormActivation(
    (0): ConvReLU2d(
      (0): Conv2d(32, 32, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), groups=32)
      (1): ReLU()
      (activation_post_process): MinMaxObserver(min_val=inf, max_val=-inf)
    )
    (1): Identity()
    (2): Identity()
  )
  (1): Conv2d(
    32, 16, kernel_size=(1, 1), stride=(1, 1)
    (activation_post_process): MinMaxObserver(min_val=inf, max_val=-inf)
  )
  (2): Identity()
)
</pre></div>
</div>
</div>
</div>
<p>ç”¨æ•°æ®é›†æ ¡å‡†ï¼š</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">num_calibration_batches</span> <span class="o">=</span> <span class="mi">200</span> <span class="c1"># å–éƒ¨åˆ†è®­ç»ƒé›†åšæ ¡å‡†</span>
<span class="n">evaluate</span><span class="p">(</span><span class="n">myModel</span><span class="p">,</span> <span class="n">criterion</span><span class="p">,</span> <span class="n">train_iter</span><span class="p">,</span> <span class="n">neval_batches</span><span class="o">=</span><span class="n">num_calibration_batches</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">PTQï¼šæ ¡å‡†å®Œæˆï¼&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>PTQï¼šæ ¡å‡†å®Œæˆï¼
</pre></div>
</div>
</div>
</div>
<p>è½¬æ¢ä¸ºé‡åŒ–æ¨¡å‹ï¼š</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">torch.ao.quantization.quantize</span> <span class="kn">import</span> <span class="n">convert</span>

<span class="n">convert</span><span class="p">(</span><span class="n">myModel</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;PTQï¼šè½¬æ¢å®Œæˆï¼&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>PTQï¼šè½¬æ¢å®Œæˆï¼
</pre></div>
</div>
</div>
</div>
<p>èåˆå¹¶é‡åŒ–åï¼ŒæŸ¥çœ‹èåˆæ¨¡å—çš„ Inverted Residual å—ï¼š</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">myModel</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">conv</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Sequential(
  (0): ConvNormActivation(
    (0): QuantizedConvReLU2d(32, 32, kernel_size=(3, 3), stride=(1, 1), scale=0.1370350867509842, zero_point=0, padding=(1, 1), groups=32)
    (1): Identity()
    (2): Identity()
  )
  (1): QuantizedConv2d(32, 16, kernel_size=(1, 1), stride=(1, 1), scale=0.20581312477588654, zero_point=69)
  (2): Identity()
)
</pre></div>
</div>
</div>
</div>
<p>é‡åŒ–åçš„æ¨¡å‹å¤§å°ï¼š</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">print_size_of_model</span><span class="p">(</span><span class="n">myModel</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>æ¨¡å‹å¤§å°ï¼š2.356113 MB
</pre></div>
</div>
</div>
</div>
<p>è¯„ä¼°ï¼š</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_type</span> <span class="o">=</span> <span class="s1">&#39;PTQ æ¨¡å‹&#39;</span>
<span class="n">top1</span><span class="p">,</span> <span class="n">top5</span> <span class="o">=</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">myModel</span><span class="p">,</span> <span class="n">criterion</span><span class="p">,</span> <span class="n">test_iter</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="si">{</span><span class="n">model_type</span><span class="si">}</span><span class="s1">ï¼š</span><span class="se">\n\t</span><span class="s1">åœ¨ </span><span class="si">{</span><span class="n">num_eval</span><span class="si">}</span><span class="s1"> å¼ å›¾ç‰‡ä¸Šè¯„ä¼° accuracy ä¸º: </span><span class="si">{</span><span class="n">top1</span><span class="o">.</span><span class="n">avg</span><span class="si">:</span><span class="s1">2.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="c1"># jit.save(jit.script(myModel), saved_model_dir + scripted_ptq_model_file)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>PTQ æ¨¡å‹ï¼š
	åœ¨ 10000 å¼ å›¾ç‰‡ä¸Šè¯„ä¼° accuracy ä¸º: 51.11
</pre></div>
</div>
</div>
</div>
<p>ä½¿ç”¨äº†ç®€å•çš„ min/max è§‚æµ‹å™¨æ¥ç¡®å®šé‡åŒ–å‚æ•°ï¼Œå°†æ¨¡å‹çš„å¤§å°å‡å°‘åˆ°äº† 2.36 MB ä»¥ä¸‹ï¼Œå‡ ä¹å‡å°‘äº† 4 å€ã€‚</p>
<p>æ­¤å¤–ï¼Œé€šè¿‡ä½¿ç”¨ä¸åŒçš„é‡åŒ–é…ç½®æ¥æ˜¾è‘—æé«˜ç²¾åº¦ï¼ˆå¯¹äºé‡åŒ– ARM æ¶æ„çš„æ¨èé…ç½®é‡å¤åŒæ ·çš„ç»ƒä¹ ï¼‰ã€‚è¯¥é…ç½®çš„æ“ä½œå¦‚ä¸‹ï¼š</p>
<ul class="simple">
<li><p>åœ¨ per-channel åŸºç¡€ä¸Šé‡åŒ–æƒé‡</p></li>
<li><p>ä½¿ç”¨ç›´æ–¹å›¾è§‚æµ‹å™¨ï¼Œæ”¶é›†æ¿€æ´»çš„ç›´æ–¹å›¾ï¼Œç„¶åä»¥æœ€ä½³æ–¹å¼é€‰æ‹©é‡åŒ–å‚æ•°ã€‚</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">per_channel_quantized_model</span> <span class="o">=</span> <span class="n">create_model</span><span class="p">(</span><span class="n">quantize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                           <span class="n">num_classes</span><span class="o">=</span><span class="n">num_classes</span><span class="p">)</span>
<span class="n">per_channel_quantized_model</span> <span class="o">=</span> <span class="n">load_model</span><span class="p">(</span><span class="n">per_channel_quantized_model</span><span class="p">,</span>
                                         <span class="n">saved_model_dir</span> <span class="o">+</span> <span class="n">float_model_file</span><span class="p">)</span>
<span class="n">per_channel_quantized_model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<span class="n">per_channel_quantized_model</span><span class="o">.</span><span class="n">fuse_model</span><span class="p">()</span>
<span class="n">per_channel_quantized_model</span><span class="o">.</span><span class="n">qconfig</span> <span class="o">=</span> <span class="n">get_default_qconfig</span><span class="p">(</span><span class="s1">&#39;fbgemm&#39;</span><span class="p">)</span>
<span class="n">per_channel_quantized_model</span><span class="o">.</span><span class="n">qconfig</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>QConfig(activation=functools.partial(&lt;class &#39;torch.ao.quantization.observer.HistogramObserver&#39;&gt;, reduce_range=True){}, weight=functools.partial(&lt;class &#39;torch.ao.quantization.observer.PerChannelMinMaxObserver&#39;&gt;, dtype=torch.qint8, qscheme=torch.per_channel_symmetric){})
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">num_calibration_batches</span> <span class="o">=</span> <span class="mi">200</span> <span class="c1"># ä»…ä»…å– 200 ä¸ªæ‰¹æ¬¡</span>
<span class="n">prepare</span><span class="p">(</span><span class="n">per_channel_quantized_model</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">evaluate</span><span class="p">(</span><span class="n">per_channel_quantized_model</span><span class="p">,</span> <span class="n">criterion</span><span class="p">,</span>
         <span class="n">train_iter</span><span class="p">,</span> <span class="n">num_calibration_batches</span><span class="p">)</span>

<span class="n">model_type</span> <span class="o">=</span> <span class="s1">&#39;PTQ æ¨¡å‹ï¼ˆç›´æ–¹å›¾è§‚æµ‹å™¨ï¼‰&#39;</span>
<span class="n">convert</span><span class="p">(</span><span class="n">per_channel_quantized_model</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">top1</span><span class="p">,</span> <span class="n">top5</span> <span class="o">=</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">per_channel_quantized_model</span><span class="p">,</span> <span class="n">criterion</span><span class="p">,</span> <span class="n">test_iter</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="si">{</span><span class="n">model_type</span><span class="si">}</span><span class="s1">ï¼š</span><span class="se">\n\t</span><span class="s1">åœ¨ </span><span class="si">{</span><span class="n">num_eval</span><span class="si">}</span><span class="s1"> å¼ å›¾ç‰‡ä¸Šè¯„ä¼° accuracy ä¸º: </span><span class="si">{</span><span class="n">top1</span><span class="o">.</span><span class="n">avg</span><span class="si">:</span><span class="s1">2.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">jit</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">jit</span><span class="o">.</span><span class="n">script</span><span class="p">(</span><span class="n">per_channel_quantized_model</span><span class="p">),</span>
         <span class="n">saved_model_dir</span> <span class="o">+</span> <span class="n">scripted_quantized_model_file</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>PTQ æ¨¡å‹ï¼ˆç›´æ–¹å›¾è§‚æµ‹å™¨ï¼‰ï¼š
	åœ¨ 10000 å¼ å›¾ç‰‡ä¸Šè¯„ä¼° accuracy ä¸º: 80.42
</pre></div>
</div>
</div>
</div>
<p>ä»…ä»…æ”¹å˜è¿™ç§é‡åŒ–é…ç½®æ–¹æ³•ï¼Œå°±å¯ä»¥å°†å‡†ç¡®åº¦æé«˜åˆ° <span class="math notranslate nohighlight">\(80.42\%\)</span> ä»¥ä¸Šï¼å°½ç®¡å¦‚æ­¤ï¼Œè¿™è¿˜æ˜¯æ¯” <span class="math notranslate nohighlight">\(95\%\)</span> çš„åŸºçº¿æ°´å¹³ä½äº† <span class="math notranslate nohighlight">\(15\%\)</span>ã€‚</p>
</section>
<section id="id11">
<h3>QAT å®æˆ˜<a class="headerlink" href="#id11" title="æ°¸ä¹…é“¾æ¥è‡³æ ‡é¢˜">#</a></h3>
<p>ä½¿ç”¨ QATï¼Œæ‰€æœ‰çš„æƒå€¼å’Œæ¿€æ´»éƒ½åœ¨å‰å‘å’Œåå‘è®­ç»ƒè¿‡ç¨‹ä¸­è¢«â€œä¼ªé‡åŒ–â€ï¼šä¹Ÿå°±æ˜¯è¯´ï¼Œæµ®ç‚¹å€¼è¢«èˆå…¥ä»¥æ¨¡æ‹Ÿ int8 å€¼ï¼Œä½†æ‰€æœ‰çš„è®¡ç®—ä»ç„¶ä½¿ç”¨æµ®ç‚¹æ•°å®Œæˆã€‚å› æ­¤ï¼Œè®­ç»ƒè¿‡ç¨‹ä¸­çš„æ‰€æœ‰æƒé‡è°ƒæ•´éƒ½æ˜¯åœ¨â€œæ„ŸçŸ¥åˆ°â€æ¨¡å‹æœ€ç»ˆå°†è¢«é‡åŒ–çš„æƒ…å†µä¸‹è¿›è¡Œçš„ï¼›å› æ­¤ï¼Œåœ¨é‡åŒ–ä¹‹åï¼Œè¿™ç§æ–¹æ³•é€šå¸¸æ¯”åŠ¨æ€é‡åŒ–æˆ–è®­ç»ƒåçš„é™æ€é‡åŒ–äº§ç”Ÿæ›´é«˜çš„ç²¾åº¦ã€‚</p>
<p>å®é™…æ‰§è¡Œ QAT çš„æ€»ä½“å·¥ä½œæµç¨‹ä¸ä¹‹å‰éå¸¸ç›¸ä¼¼ï¼š</p>
<ul class="simple">
<li><p>å¯ä»¥ä½¿ç”¨ä¸ä»¥å‰ç›¸åŒçš„æ¨¡å‹ï¼šä¸éœ€è¦ä¸ºé‡åŒ–æ„ŸçŸ¥è®­ç»ƒåšé¢å¤–çš„å‡†å¤‡ã€‚</p></li>
<li><p>éœ€è¦ä½¿ç”¨ <code class="docutils literal notranslate"><span class="pre">qconfig</span></code> æ¥æŒ‡å®šåœ¨æƒé‡å’Œæ¿€æ´»ä¹‹åæ’å…¥ä½•ç§ç±»å‹çš„ä¼ªé‡åŒ–ï¼Œè€Œä¸æ˜¯æŒ‡å®šè§‚æµ‹è€…ã€‚</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">create_qat_model</span><span class="p">(</span><span class="n">num_classes</span><span class="p">,</span>
                     <span class="n">model_path</span><span class="p">,</span>
                     <span class="n">quantize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                     <span class="n">backend</span><span class="o">=</span><span class="s1">&#39;fbgemm&#39;</span><span class="p">):</span>
    <span class="n">qat_model</span> <span class="o">=</span> <span class="n">create_model</span><span class="p">(</span><span class="n">quantize</span><span class="o">=</span><span class="n">quantize</span><span class="p">,</span>
                             <span class="n">num_classes</span><span class="o">=</span><span class="n">num_classes</span><span class="p">)</span>
    <span class="n">qat_model</span> <span class="o">=</span> <span class="n">load_model</span><span class="p">(</span><span class="n">qat_model</span><span class="p">,</span> <span class="n">model_path</span><span class="p">)</span>
    <span class="n">qat_model</span><span class="o">.</span><span class="n">fuse_model</span><span class="p">()</span>
    <span class="n">qat_model</span><span class="o">.</span><span class="n">qconfig</span> <span class="o">=</span> <span class="n">get_default_qat_qconfig</span><span class="p">(</span><span class="n">backend</span><span class="o">=</span><span class="n">backend</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">qat_model</span>
</pre></div>
</div>
</div>
</div>
<p>æœ€åï¼Œ<code class="docutils literal notranslate"><span class="pre">prepare_qat</span></code> æ‰§è¡Œâ€œä¼ªé‡åŒ–â€ï¼Œä¸ºé‡åŒ–æ„ŸçŸ¥è®­ç»ƒå‡†å¤‡æ¨¡å‹ï¼š</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">torch.ao.quantization.quantize</span> <span class="kn">import</span> <span class="n">prepare_qat</span>

<span class="n">model_path</span> <span class="o">=</span> <span class="n">saved_model_dir</span> <span class="o">+</span> <span class="n">float_model_file</span>
<span class="n">qat_model</span> <span class="o">=</span> <span class="n">create_qat_model</span><span class="p">(</span><span class="n">num_classes</span><span class="p">,</span> <span class="n">model_path</span><span class="p">)</span>
<span class="n">qat_model</span> <span class="o">=</span> <span class="n">prepare_qat</span><span class="p">(</span><span class="n">qat_model</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Inverted Residual Blockï¼šå‡†å¤‡å¥½ QAT åï¼Œæ³¨æ„ä¼ªé‡åŒ–æ¨¡å—ï¼š</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">qat_model</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">conv</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Sequential(
  (0): ConvNormActivation(
    (0): ConvBnReLU2d(
      32, 32, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), groups=32, bias=False
      (bn): BatchNorm2d(32, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (weight_fake_quant): FusedMovingAvgObsFakeQuantize(
        fake_quant_enabled=tensor([1]), observer_enabled=tensor([1]), scale=tensor([1.]), zero_point=tensor([0], dtype=torch.int32), dtype=torch.qint8, quant_min=-128, quant_max=127, qscheme=torch.per_channel_symmetric, reduce_range=False
        (activation_post_process): MovingAveragePerChannelMinMaxObserver(min_val=tensor([]), max_val=tensor([]))
      )
      (activation_post_process): FusedMovingAvgObsFakeQuantize(
        fake_quant_enabled=tensor([1]), observer_enabled=tensor([1]), scale=tensor([1.]), zero_point=tensor([0], dtype=torch.int32), dtype=torch.quint8, quant_min=0, quant_max=127, qscheme=torch.per_tensor_affine, reduce_range=True
        (activation_post_process): MovingAverageMinMaxObserver(min_val=inf, max_val=-inf)
      )
    )
    (1): Identity()
    (2): Identity()
  )
  (1): ConvBn2d(
    32, 16, kernel_size=(1, 1), stride=(1, 1), bias=False
    (bn): BatchNorm2d(16, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
    (weight_fake_quant): FusedMovingAvgObsFakeQuantize(
      fake_quant_enabled=tensor([1]), observer_enabled=tensor([1]), scale=tensor([1.]), zero_point=tensor([0], dtype=torch.int32), dtype=torch.qint8, quant_min=-128, quant_max=127, qscheme=torch.per_channel_symmetric, reduce_range=False
      (activation_post_process): MovingAveragePerChannelMinMaxObserver(min_val=tensor([]), max_val=tensor([]))
    )
    (activation_post_process): FusedMovingAvgObsFakeQuantize(
      fake_quant_enabled=tensor([1]), observer_enabled=tensor([1]), scale=tensor([1.]), zero_point=tensor([0], dtype=torch.int32), dtype=torch.quint8, quant_min=0, quant_max=127, qscheme=torch.per_tensor_affine, reduce_range=True
      (activation_post_process): MovingAverageMinMaxObserver(min_val=inf, max_val=-inf)
    )
  )
  (2): Identity()
)
</pre></div>
</div>
</div>
</div>
<p>è®­ç»ƒå…·æœ‰é«˜ç²¾ç¡®åº¦çš„é‡åŒ–æ¨¡å‹è¦æ±‚åœ¨æ¨ç†æ—¶å¯¹æ•°å€¼è¿›è¡Œç²¾ç¡®çš„å»ºæ¨¡ã€‚å› æ­¤ï¼Œå¯¹äºé‡åŒ–æ„ŸçŸ¥è®­ç»ƒï¼Œæˆ‘ä»¬å¯¹è®­ç»ƒå¾ªç¯è¿›è¡Œå¦‚ä¸‹ä¿®æ”¹ï¼š</p>
<ul class="simple">
<li><p>å°†æ‰¹å¤„ç†èŒƒæ•°è½¬æ¢ä¸ºè®­ç»ƒç»“æŸæ—¶çš„è¿è¡Œå‡å€¼å’Œæ–¹å·®ï¼Œä»¥æ›´å¥½åœ°åŒ¹é…æ¨ç†æ•°å€¼ã€‚</p></li>
<li><p>å†»ç»“é‡åŒ–å™¨å‚æ•°ï¼ˆå°ºåº¦å’Œé›¶ç‚¹ï¼‰å¹¶å¾®è°ƒæƒé‡ã€‚</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">CV</span><span class="o">.</span><span class="n">train_fine_tuning</span><span class="p">(</span><span class="n">qat_model</span><span class="p">,</span>
                     <span class="n">train_iter</span><span class="p">,</span>
                     <span class="n">test_iter</span><span class="p">,</span>
                     <span class="n">learning_rate</span><span class="o">=</span><span class="n">learning_rate</span><span class="p">,</span>
                     <span class="n">num_epochs</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
                     <span class="n">device</span><span class="o">=</span><span class="s1">&#39;cuda:2&#39;</span><span class="p">,</span>
                     <span class="n">param_group</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                     <span class="n">is_freeze</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                     <span class="n">is_quantized_acc</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                     <span class="n">need_qconfig</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                     <span class="n">ylim</span><span class="o">=</span><span class="p">[</span><span class="mf">0.8</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>loss 0.013, train acc 0.996, test acc 0.948
55.3 examples/sec on cuda:2
</pre></div>
</div>
<img alt="../../_images/c6e58c277bc331ef7c29229b3dbfba0803701348a36be19c173df10b07ccdf2b.svg" src="../../_images/c6e58c277bc331ef7c29229b3dbfba0803701348a36be19c173df10b07ccdf2b.svg" /></div>
</div>
<div class="admonition note">
<p class="admonition-title">å¤‡æ³¨</p>
<p>è¿™é‡Œçš„æŸå¤±å‡½æ•°å‘ä¸Šå¹³ç§»äº† 0.8 ä»¥æä¾›æ›´å¥½çš„è§†è§‰æ•ˆæœã€‚</p>
</div>
<p>ç”±äºé‡åŒ–æ¨¡å‹æš‚ä»…æ”¯æŒ CPUï¼Œæ•…è€Œéœ€è¦å…ˆå°†æ¨¡å‹è½¬æ¢ä¸º CPU ç‰ˆæœ¬ï¼Œåˆ™è½¬ä¸ºé‡åŒ–ç‰ˆæœ¬ï¼š</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">convert</span><span class="p">(</span><span class="n">qat_model</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">eval</span><span class="p">(),</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">qat_model</span><span class="o">.</span><span class="n">eval</span><span class="p">();</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">print_info</span><span class="p">(</span><span class="n">qat_model</span><span class="p">,</span><span class="s1">&#39;QAT æ¨¡å‹&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>æ¨¡å‹å¤§å°ï¼š2.656573 MB

QAT æ¨¡å‹ï¼š
	åœ¨ 10000 å¼ å›¾ç‰‡ä¸Šè¯„ä¼° accuracy ä¸º: 94.41000
</pre></div>
</div>
</div>
</div>
<p>é‡åŒ–æ„ŸçŸ¥è®­ç»ƒåœ¨æ•´ä¸ªæ•°æ®é›†ä¸Šçš„å‡†ç¡®ç‡è¶…è¿‡ <span class="math notranslate nohighlight">\(94.4\%\)</span>ï¼Œæ¥è¿‘æµ®ç‚¹ç²¾åº¦ <span class="math notranslate nohighlight">\(95\%\)</span>ã€‚</p>
<p>æ›´å¤šå…³äº QAT çš„å†…å®¹ï¼š</p>
<ul class="simple">
<li><p>QAT æ˜¯åè®­ç»ƒé‡åŒ–æŠ€æœ¯çš„è¶…é›†ï¼Œå…è®¸æ›´å¤šçš„è°ƒè¯•ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥åˆ†ææ¨¡å‹çš„å‡†ç¡®æ€§æ˜¯å¦å—åˆ°æƒé‡æˆ–æ¿€æ´»é‡åŒ–çš„é™åˆ¶ã€‚</p></li>
<li><p>ä¹Ÿå¯ä»¥åœ¨æµ®ç‚¹ä¸Šæ¨¡æ‹Ÿé‡åŒ–æ¨¡å‹çš„å‡†ç¡®æ€§ï¼Œå› ä¸ºä½¿ç”¨ä¼ªé‡åŒ–æ¥æ¨¡æ‹Ÿå®é™…é‡åŒ–ç®—æ³•çš„æ•°å€¼ã€‚</p></li>
<li><p>ä¹Ÿå¯ä»¥å¾ˆå®¹æ˜“åœ°æ¨¡æ‹Ÿè®­ç»ƒåé‡åŒ–ã€‚</p></li>
</ul>
<p>ä¿å­˜ QAT æ¨¡å‹ï¼š</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">jit</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">jit</span><span class="o">.</span><span class="n">script</span><span class="p">(</span><span class="n">qat_model</span><span class="p">),</span> <span class="n">saved_model_dir</span> <span class="o">+</span> <span class="n">scripted_qat_model_file</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id12">
<h3>å°ç»“<a class="headerlink" href="#id12" title="æ°¸ä¹…é“¾æ¥è‡³æ ‡é¢˜">#</a></h3>
<p>åŒæ ·å¯ä»¥ä½¿ç”¨ <a class="reference external" href="https://xinetzone.github.io/pytorch-book/api/pytorch/ao/quantization/generated/torch.ao.quantization.quantize.quantize.html#torch.ao.quantization.quantize.quantize" title="(åœ¨ Pytorch Book)"><code class="xref py py-func docutils literal notranslate"><span class="pre">quantize()</span></code></a> å’Œ <a class="reference external" href="https://xinetzone.github.io/pytorch-book/api/pytorch/ao/quantization/generated/torch.ao.quantization.quantize.quantize_qat.html#torch.ao.quantization.quantize.quantize_qat" title="(åœ¨ Pytorch Book)"><code class="xref py py-func docutils literal notranslate"><span class="pre">quantize_qat()</span></code></a> ç®€åŒ–æµç¨‹ã€‚</p>
<p>æ¯”å¦‚ï¼ŒQAT æµç¨‹å¯ä»¥è¿™æ ·ï¼š</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">model_path</span> <span class="o">=</span> <span class="n">saved_model_dir</span> <span class="o">+</span> <span class="n">float_model_file</span>
<span class="n">qat_model</span> <span class="o">=</span> <span class="n">create_qat_model</span><span class="p">(</span><span class="n">num_classes</span><span class="p">,</span> <span class="n">model_path</span><span class="p">)</span>
<span class="n">num_epochs</span> <span class="o">=</span> <span class="mi">30</span>
<span class="n">ylim</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.8</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">device</span> <span class="o">=</span> <span class="s1">&#39;cuda:2&#39;</span>
<span class="n">is_freeze</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">is_quantized_acc</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">need_qconfig</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># åšä¸€äº› QAT çš„é‡åŒ–é…ç½®å·¥ä½œ</span>
<span class="n">param_group</span> <span class="o">=</span> <span class="kc">True</span>

<span class="c1"># æä¾›ä½ç½®å‚æ•°</span>
<span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">train_iter</span><span class="p">,</span>
        <span class="n">test_iter</span><span class="p">,</span>
        <span class="n">learning_rate</span><span class="p">,</span>
        <span class="n">num_epochs</span><span class="p">,</span>
        <span class="n">device</span><span class="p">,</span>
        <span class="n">is_freeze</span><span class="p">,</span>
        <span class="n">is_quantized_acc</span><span class="p">,</span>
        <span class="n">need_qconfig</span><span class="p">,</span>
        <span class="n">param_group</span><span class="p">,</span>
        <span class="n">ylim</span><span class="p">]</span>

<span class="n">quantized_model</span> <span class="o">=</span> <span class="n">quantize_qat</span><span class="p">(</span><span class="n">qat_model</span><span class="p">,</span> <span class="n">CV</span><span class="o">.</span><span class="n">train_fine_tuning</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
</pre></div>
</div>
<p>ç®€è€Œè¨€ä¹‹ï¼Œä¸ç®¡æ˜¯ PTQ è¿˜æ˜¯ QATï¼Œæˆ‘ä»¬åªéœ€è¦è‡ªå®šä¹‰èåˆæ¨¡å—å‡½æ•°å’Œé‡åŒ–æ ¡å‡†å‡½æ•°ï¼ˆæ¯”å¦‚ QAT çš„è®­ç»ƒä¸­æ ¡å‡†ï¼ŒPTQ çš„è®­ç»ƒåæ ¡å‡†ï¼‰ã€‚</p>
</section>
</section>
</section>

<div class="section">
   
</div>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By xinetzone<br/>
  
      &copy; Copyright 2021, xinetzone.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>